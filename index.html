<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Inventory Manager (cons-593c6)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 3. Load Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Load Firebase SDKs -->
    <script type="module">
      // This is a workaround to make Firebase SDKs available to the Babel script
      // by attaching them to the window object.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        addDoc, 
        setDoc, 
        updateDoc, 
        deleteDoc, 
        onSnapshot, 
        collection, 
        query, 
        setLogLevel,
        serverTimestamp,
        orderBy,
        getDoc // New: Needed for checking user role
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.firebase = {
        app: { initializeApp },
        auth: { 
          getAuth, 
          onAuthStateChanged,
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          signOut
        },
        firestore: {
          getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
          collection, query, setLogLevel, serverTimestamp, orderBy, getDoc // New
        }
      };
    </script>
    
    <style>
      body { font-family: 'Inter', sans-serif; }
      #loading {
        display: flex; justify-content: center; align-items: center;
        height: 100vh; font-size: 1.2rem; font-weight: 500; color: #333;
      }
      /* Simple disable style */
      button:disabled, select:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
    </style>
</head>
<body class="bg-gray-100">
    
    <div id="root">
        <div id="loading">Connecting to your lab inventory...</div>
    </div>

    <!-- 5. React App Code (transpiled by Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyACGODYoAc5Yc7dzX8aYlX8t-UhPUyy9oM",
          authDomain: "cons-593c6.firebaseapp.com",
          projectId: "cons-593c6",
          storageBucket: "cons-593c6.firebasestorage.app",
          messagingSenderId: "674188672813",
          appId: "1:674188672813:web:887caed5ea2fc927fbdda4",
          measurementId: "G-TK88H80GYC"
        };
        
        const appId = "cons-593c6"; 
        
        // --- Destructure Firebase from window ---
        const { initializeApp } = window.firebase.app;
        const { 
          getAuth, 
          onAuthStateChanged,
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          signOut
        } = window.firebase.auth;
        const { 
          getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
          onSnapshot, collection, query, setLogLevel, serverTimestamp, orderBy,
          getDoc
        } = window.firebase.firestore;


        // --- Helper Functions & Constants ---
        const formatDate = (dateInput, includeTime = false) => {
          if (!dateInput) return 'N/A';
          let date;
          if (dateInput && dateInput.toDate) {
            date = dateInput.toDate();
          } else if (typeof dateInput === 'string') {
            date = new Date(dateInput);
          } else {
            date = dateInput;
          }
          if (!date || isNaN(date.getTime())) return 'N/A';
          const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
          const timeOptions = { hour: '2-digit', minute: '2-digit' };
          let formattedDate;
          if (includeTime) {
            formattedDate = date.toLocaleString('en-US', {...dateOptions, ...timeOptions});
          } else {
            formattedDate = date.toLocaleDateString('en-US', dateOptions);
          }
          return formattedDate.replace(',', ''); 
        };
        
        const sanitizeForCSV = (value) => {
          if (value == null) return '';
          let strValue = String(value);
          if (strValue.search(/("|,|\n)/g) >= 0) {
            strValue = strValue.replace(/"/g, '""');
            return `"${strValue}"`;
          }
          return strValue;
        };

        const exportToCSV = (data, headers, filename) => {
          const csvRows = [];
          csvRows.push(headers.map(sanitizeForCSV).join(','));
          for (const item of data) {
            const values = headers.map(headerKey => {
              if (headerKey === 'itemName' && item.masterItem) {
                 return sanitizeForCSV(`${item.masterItem.itemId} - ${item.masterItem.nameAndSpec}`);
              }
              if (headerKey === 'timestamp' && item.timestamp) {
                 return sanitizeForCSV(formatDate(item.timestamp, true));
              }
              if (headerKey === 'userEmail' && item.userEmail) {
                return sanitizeForCSV(item.userEmail);
              }
              return sanitizeForCSV(item[headerKey]);
            });
            csvRows.push(values.join(','));
          }
          const csvString = csvRows.join('\n');
          const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        };


        // --- Inline SVG Icons ---
        const IconPlus = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const IconTrash = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
        const IconEdit = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>);
        const IconClipboard = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>);
        const IconHistory = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>);
        const IconDownload = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>);
        const IconMinus = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const IconSignOut = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const IconX = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const IconAlertTriangle = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500 inline-block mr-1"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        // New Admin Icon
        const IconAdmin = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);


        // --- Reusable UI Components ---
        const Modal = ({ isOpen, onClose, title, children, allowClose = true }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" aria-modal="true" role="dialog">
              <div className="relative w-full max-w-2xl bg-white rounded-lg shadow-xl m-4">
                <div className="flex items-center justify-between p-4 border-b rounded-t">
                  <h3 className="text-xl font-semibold text-gray-900">{title}</h3>
                  {allowClose && (
                    <button type="button" className="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onClick={onClose} aria-label="Close modal">
                      <IconX />
                    </button>
                  )}
                </div>
                <div className="p-6 space-y-6">{children}</div>
              </div>
            </div>
          );
        };
        
        const TakeStockModal = ({ isOpen, onClose, item, onConfirm }) => {
          const [takeAmount, setTakeAmount] = useState(1);
          const [error, setError] = useState('');
          const masterItem = item?.masterItem || {};
          const currentQty = item?.quantity || 0;

          const handleSubmit = (e) => {
            e.preventDefault();
            const amount = Number(takeAmount);
            if (amount <= 0) { setError("Amount must be greater than zero."); return; }
            if (amount > currentQty) { setError(`Amount cannot be more than the ${currentQty} in stock.`); return; }
            onConfirm(amount);
          };
          
          useEffect(() => { if (isOpen) { setTakeAmount(1); setError(''); } }, [isOpen]);

          return (
            <Modal isOpen={isOpen} onClose={onClose} title="Take Stock" allowClose={true}>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <h4 className="font-medium text-gray-800">{masterItem.itemId} - {masterItem.nameAndSpec}</h4>
                  <p className="text-sm text-gray-600">Lot #: {item?.lotNumber}</p>
                  <p className="text-sm text-gray-600">Currently in Stock: <span className="font-bold">{currentQty}</span></p>
                </div>
                <Input label="Quantity to Take:" id="takeAmount" name="takeAmount" type="number" min="1" max={currentQty} value={takeAmount} onChange={(e) => setTakeAmount(e.target.value)} required autoFocus />
                {error && <p className="text-red-600 text-sm">{error}</p>}
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button type="button" variant="secondary" onClick={onClose}>Cancel</Button>
                  <Button type="submit" variant="primary">Confirm & Log</Button>
                </div>
              </form>
            </Modal>
          );
        };

        const Input = ({ label, id, ...props }) => (
          <div>
            <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900">{label}</label>
            <input id={id} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed" {...props} />
          </div>
        );

        const Select = ({ label, id, children, ...props }) => (
          <div>
            <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900">{label}</label>
            <select id={id} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed" {...props}>
              {children}
            </select>
          </div>
        );

        const Button = ({ children, onClick, variant = 'primary', type = 'button', ...props }) => {
          const baseStyle = "px-4 py-2 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed";
          const variants = {
            primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
            danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
            secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
            warning: 'bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400'
          };
          return (
            <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]}`} {...props}>
              {children}
            </button>
          );
        };

        // --- Log Helper Function ---
        const logChange = async (db, user, item, action, quantityChange, newQuantity, newStatus = null) => {
          if (!db || !appId || !user || !user.uid || !user.email) {
            console.error("Log failed: DB, AppID, or User missing.");
            return;
          }
          const logCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventoryLog');
          const masterItem = item.masterItem || { itemId: 'N/A', nameAndSpec: 'N/A' };
          const logEntry = {
            timestamp: serverTimestamp(),
            userId: user.uid, 
            userEmail: user.email, // Use email for logging
            inventoryItemId: item.id || 'N/A',
            masterItemId: item.masterItemId,
            itemName: `${masterItem.itemId} - ${masterItem.nameAndSpec}`,
            lotNumber: item.lotNumber,
            action: action,
            quantityChange: quantityChange,
            newQuantity: newQuantity,
            status: newStatus || item.status,
          };
          try {
            await addDoc(logCollectionRef, logEntry);
          } catch (err) {
            console.error("Error writing to log: ", err);
          }
        };


        // --- Master List Component ---
        const MasterList = ({ db, user, userRole, masterItems, isLoading, error }) => {
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [currentItemId, setCurrentItemId] = useState(null);
          const [form, setForm] = useState({
            itemId: '', category: 'Sample Prep', nameAndSpec: '',
            approvedSuppliers: '', verificationAction: '', lowStockThreshold: 3,
          });

          const categories = ['Sample Prep', 'Chemical Analysis', 'General Lab'];
          
          // Role Check
          const canManage = userRole === 'admin';

          const resetForm = () => {
            setForm({
              itemId: '', category: 'Sample Prep', nameAndSpec: '',
              approvedSuppliers: '', verificationAction: '', lowStockThreshold: 3,
            });
            setIsEditing(false);
            setCurrentItemId(null);
          };

          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (item) => {
            setForm({
              itemId: item.itemId, category: item.category, nameAndSpec: item.nameAndSpec,
              approvedSuppliers: item.approvedSuppliers, verificationAction: item.verificationAction,
              lowStockThreshold: item.lowStockThreshold || 3,
            });
            setIsEditing(true);
            setCurrentItemId(item.id);
            setIsModalOpen(true);
          };
          const closeModal = () => { setIsModalOpen(false); resetForm(); };

          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setForm((prev) => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !canManage) return; // Permission check
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'masterList');
              if (isEditing) {
                await setDoc(doc(collectionRef, currentItemId), form);
              } else {
                await addDoc(collectionRef, form);
              }
              closeModal();
            } catch (err) { console.error("Error saving master item: ", err); }
          };

          const handleDelete = async (docId) => {
            if (!canManage || !window.confirm("Are you sure you want to delete this master item?")) return;
            if (!db) return;
            try {
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'masterList', docId));
            } catch (err) { console.error("Error deleting item: ", err); }
          };
          
          const handleExport = () => {
            const headers = ['itemId', 'category', 'nameAndSpec', 'approvedSuppliers', 'verificationAction', 'lowStockThreshold'];
            exportToCSV(masterItems, headers, 'master-consumable-list.csv');
          };

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">Master Consumable List</h2>
                <div className="flex gap-2">
                  <Button onClick={handleExport} variant="secondary">
                    <IconDownload /> Export to CSV
                  </Button>
                  {/* --- PERMISSION CHECK --- */}
                  {canManage && (
                    <Button onClick={openAddModal} variant="primary">
                      <IconPlus /> Add New Master Item
                    </Button>
                  )}
                </div>
              </div>

              {isLoading && <p>Loading master list...</p>}
              {error && <p className="text-red-500">{error}</p>}
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name & Specification</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved Suppliers</th>
                      {/* --- PERMISSION CHECK (Hide for non-admins) --- */}
                      {canManage && <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {masterItems.map((item) => (
                      <tr key={item.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.itemId}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.category}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.nameAndSpec}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.approvedSuppliers}</td>
                        {/* --- PERMISSION CHECK --- */}
                        {canManage && (
                          <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div className="flex justify-end gap-2">
                              <Button variant="secondary" onClick={() => openEditModal(item)} aria-label="Edit"><IconEdit /></Button>
                              <Button variant="danger" onClick={() => handleDelete(item.id)} aria-label="Delete"><IconTrash /></Button>
                            </div>
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Modal is still here, but 'Add' button to open it is hidden */}
              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? "Edit Master Item" : "Add New Master Item"} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  {/* Form inputs... (same as before) */}
                  <Input label="Item ID (e.g., SP-001)" id="itemId" name="itemId" value={form.itemId} onChange={handleChange} required />
                  <Select label="Category" id="category" name="category" value={form.category} onChange={handleChange}>
                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </Select>
                  <Input label="Name & Specification" id="nameAndSpec" name="nameAndSpec" value={form.nameAndSpec} onChange={handleChange} required />
                  <Input label="Approved Suppliers" id="approvedSuppliers" name="approvedSuppliers" value={form.approvedSuppliers} onChange={handleChange} />
                  <Input label="Acceptance / Verification Action" id="verificationAction" name="verificationAction" value={form.verificationAction} onChange={handleChange} />
                  <Input label="Low Stock Threshold" id="lowStockThreshold" name="lowStockThreshold" type="number" min="0" value={form.lowStockThreshold} onChange={handleChange} />
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>Cancel</Button>
                    <Button type="submit" variant="primary">{isEditing ? "Save Changes" : "Add Item"}</Button>
                  </div>
                </form>
              </Modal>
            </div>
          );
        };

        // --- Active Inventory Component ---
        const ActiveInventory = ({ db, user, userRole, masterItems }) => {
          const [inventoryItems, setInventoryItems] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [isTakeModalOpen, setIsTakeModalOpen] = useState(false);
          const [currentItem, setCurrentItem] = useState(null); 
          const [form, setForm] = useState({
            masterItemId: '', lotNumber: '', dateReceived: '', expirationDate: '',
            quantity: 1, storageLocation: '', status: 'Approved for Use',
          });
          
          const statuses = ['Approved for Use', 'Quarantined', 'Disposed', 'Expired'];
          
          // Role Check
          const canManage = ['admin', 'technician'].includes(userRole);

          const masterItemMap = useMemo(() => {
            return masterItems.reduce((acc, item) => {
              acc[item.id] = item;
              return acc;
            }, {});
          }, [masterItems]);

          useEffect(() => {
            if (!db) return;
            setIsLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => {
                const data = doc.data();
                return { id: doc.id, ...data, masterItem: masterItemMap[data.masterItemId] || { itemId: 'N/A', nameAndSpec: 'N/A' } }
              });
              setInventoryItems(items);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching inventory: ", err); setError("Failed to load inventory."); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, user.uid, masterItemMap]);

          const resetForm = () => {
            setForm({
              masterItemId: masterItems.length > 0 ? masterItems[0].id : '', lotNumber: '', dateReceived: '',
              expirationDate: '', quantity: 1, storageLocation: '', status: 'Approved for Use',
            });
            setIsEditing(false);
            setCurrentItem(null);
          };

          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (item) => {
            setForm({
              masterItemId: item.masterItemId, lotNumber: item.lotNumber, dateReceived: item.dateReceived,
              expirationDate: item.expirationDate, quantity: item.quantity,
              storageLocation: item.storageLocation, status: item.status,
            });
            setIsEditing(true);
            setCurrentItem(item); 
            setIsModalOpen(true);
          };
          const openTakeModal = (item) => { setCurrentItem(item); setIsTakeModalOpen(true); };
          const closeModal = () => { setIsModalOpen(false); setIsTakeModalOpen(false); resetForm(); };

          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setForm((prev) => ({ ...prev, [name]: type === 'number' ? Number(value) : value, }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !user || !canManage) return; // Permission Check
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
              if (isEditing) {
                const docRef = doc(collectionRef, currentItem.id);
                await setDoc(docRef, form);
                const oldQty = currentItem.quantity; const newQty = form.quantity;
                const oldStatus = currentItem.status; const newStatus = form.status;
                if (oldQty !== newQty) {
                  const change = newQty - oldQty;
                  const action = change > 0 ? "Stock Added" : "Stock Used/Correction";
                  await logChange(db, user, currentItem, action, change, newQty, newStatus);
                }
                if (oldStatus !== newStatus && oldQty === newQty) {
                  await logChange(db, user, currentItem, "Status Change", 0, newQty, newStatus);
                }
              } else {
                const newDocRef = await addDoc(collectionRef, form);
                const newItem = { ...form, id: newDocRef.id, masterItem: masterItemMap[form.masterItemId] };
                await logChange(db, user, newItem, "New Item Added", form.quantity, form.quantity);
              }
              closeModal();
            } catch (err) { console.error("Error saving inventory item: ", err); }
          };
          
          const handleTakeStock = async (takeAmount) => {
            if (!db || !user || !currentItem || !canManage) return; // Permission Check
            const newQuantity = currentItem.quantity - takeAmount;
            try {
              await logChange(db, user, currentItem, "Stock Used", -takeAmount, newQuantity, currentItem.status);
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', currentItem.id);
              await updateDoc(docRef, { quantity: newQuantity });
              closeModal();
            } catch (err) { console.error("Error taking stock: ", err); }
          };
          
          const handleDelete = async (item) => {
            if (!canManage || !window.confirm(`Are you sure you want to delete Lot ${item.lotNumber}? This action will be logged.`)) return;
            if (!db || !user) return;
            try {
              await logChange(db, user, item, "Item Deleted", -item.quantity, 0, "Disposed");
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', item.id));
            } catch (err) { console.error("Error deleting item: ", err); }
          };
          
          const handleStatusChange = async (docId, newStatus) => {
            if (!db || !user || !canManage) return; // Permission Check
            const item = inventoryItems.find(i => i.id === docId);
            if (!item) return;
            try {
              await logChange(db, user, item, "Status Change", 0, item.quantity, newStatus);
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', docId), { status: newStatus });
            } catch (err) { console.error("Error updating status: ", err); }
          };
          
          const getStatusColor = (status, expDate) => {
            const isExpired = expDate && new Date(expDate) < new Date();
            if (status === 'Disposed') return 'bg-gray-200 text-gray-800';
            if (status === 'Expired' || isExpired) return 'bg-red-100 text-red-800';
            if (status === 'Quarantined') return 'bg-yellow-100 text-yellow-800';
            return 'bg-green-100 text-green-800';
          };

          const lowStockItems = useMemo(() => {
            return inventoryItems
              .map(item => {
                const masterItem = masterItemMap[item.masterItemId];
                const threshold = masterItem?.lowStockThreshold || 3;
                if (item.quantity <= threshold && item.status === 'Approved for Use') {
                  return { id: item.id, name: masterItem ? `${masterItem.itemId} - ${masterItem.nameAndSpec}` : 'Unknown Item',
                    quantity: item.quantity, threshold: threshold, };
                }
                return null;
              })
              .filter(Boolean);
          }, [inventoryItems, masterItemMap]);

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">Active Inventory</h2>
                {/* --- PERMISSION CHECK --- */}
                {canManage && (
                  <Button onClick={openAddModal} variant="primary" disabled={masterItems.length === 0}>
                    <IconPlus /> Add New Stock
                  </Button>
                )}
              </div>
              
              {masterItems.length === 0 && ( /* ... (same as before) ... */ )}
              {lowStockItems.length > 0 && ( /* ... (same as before) ... */ )}
              {isLoading && <p>Loading inventory...</p>}
              {error && <p className="text-red-500">{error}</p>}

              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lot #</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expires</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                      {/* --- PERMISSION CHECK --- */}
                      {canManage && <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {inventoryItems.map((item) => {
                      const masterItem = item.masterItem;
                      const itemName = masterItem ? `${masterItem.itemId} - ${masterItem.nameAndSpec}` : "Loading...";
                      const statusColor = getStatusColor(item.status, item.expirationDate);
                      const lowStockThreshold = masterItem?.lowStockThreshold || 3;
                      const isLowStock = item.quantity <= lowStockThreshold && item.status === 'Approved for Use';
                      const canTake = item.quantity > 0 && item.status === 'Approved for Use' && canManage;
                      
                      return (
                        <tr key={item.id}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{itemName}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lotNumber}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm ${statusColor.includes('red') ? 'font-bold' : 'text-gray-500'}`}>{formatDate(item.expirationDate)}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm text-center ${isLowStock ? 'font-bold text-yellow-700' : 'text-gray-500'}`}>{isLowStock && <IconAlertTriangle />}{item.quantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.storageLocation}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm">
                            <select value={item.status} onChange={(e) => handleStatusChange(item.id, e.target.value)} disabled={!canManage} className={`text-xs font-medium rounded-full p-1 border-none ${statusColor}`}>
                              {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                          </td>
                          {/* --- PERMISSION CHECK --- */}
                          {canManage && (
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                              <div className="flex justify-end gap-2">
                                <Button variant="warning" onClick={() => openTakeModal(item)} aria-label="Take" disabled={!canTake}>
                                  <IconMinus /> Take
                                </Button>
                                <Button variant="secondary" onClick={() => openEditModal(item)} aria-label="Edit"><IconEdit /></Button>
                                <Button variant="danger" onClick={() => handleDelete(item)} aria-label="Delete"><IconTrash /></Button>
                              </div>
                            </td>
                          )}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              {/* Edit/Add Modal */}
              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? "Edit Inventory Item" : "Add New Stock Item"} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  {/* Form inputs... (same as before) */}
                  <Select label="Master Item" id="masterItemId" name="masterItemId" value={form.masterItemId} onChange={handleChange} required disabled={isEditing}>
                    <option value="" disabled>Select an approved item</option>
                    {masterItems.map(item => (<option key={item.id} value={item.id}>{item.itemId} - {item.nameAndSpec}</option>))}
                  </Select>
                  <Input label="Lot / Batch Number" id="lotNumber" name="lotNumber" value={form.lotNumber} onChange={handleChange} required disabled={isEditing} />
                  <Input label="Date Received" id="dateReceived" name="dateReceived" type="date" value={form.dateReceived} onChange={handleChange} required />
                  <Input label="Expiration Date" id="expirationDate" name="expirationDate" type="date" value={form.expirationDate} onChange={handleChange} />
                  <Input label="Quantity" id="quantity" name="quantity" type="number" min="0" value={form.quantity} onChange={handleChange} required />
                  <Input label="Storage Location" id="storageLocation" name="storageLocation" value={form.storageLocation} onChange={handleChange} />
                  <Select label="Status" id="status" name="status" value={form.status} onChange={handleChange}>
                    {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                  </Select>
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>Cancel</Button>
                    <Button type="submit" variant="primary">{isEditing ? "Save Changes" : "Add Item"}</Button>
                  </div>
                </form>
              </Modal>
              
              <TakeStockModal isOpen={isTakeModalOpen} onClose={closeModal} item={currentItem} onConfirm={handleTakeStock} />
            </div>
          );
        };

        // --- Inventory Log Component ---
        const InventoryLog = ({ db, masterItemMap }) => {
          const [logItems, setLogItems] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);

          useEffect(() => {
            if (!db) return;
            setIsLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventoryLog');
            const q = query(collectionRef, orderBy('timestamp', 'desc')); 
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const items = snapshot.docs.map(doc => {
                const data = doc.data();
                return { id: doc.id, ...data, masterItem: masterItemMap[data.masterItemId] || { itemId: 'N/A', nameAndSpec: 'N/A' } }
              });
              setLogItems(items);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching log: ", err); setError("Failed to load inventory log."); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, masterItemMap]);
          
          const handleExport = () => {
             const headers = ['timestamp', 'userEmail', 'itemName', 'lotNumber', 'action', 'quantityChange', 'newQuantity', 'status'];
            exportToCSV(logItems, headers, 'inventory-log.csv');
          };
          
          const getActionColor = (action) => {
            if (action.includes("Added")) return 'text-green-600';
            if (action.includes("Used")) return 'text-yellow-700';
            if (action.includes("Deleted")) return 'text-red-600';
            return 'text-gray-600';
          };
          
          const formatChange = (change) => {
            if (change > 0) return `+${change}`;
            if (change < 0) return `${change}`;
            return '0';
          }

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">Inventory Log</h2>
                <Button onClick={handleExport} variant="secondary">
                  <IconDownload /> Export to CSV
                </Button>
              </div>
              
              {isLoading && <p>Loading log...</p>}
              {error && <p className="text-red-500">{error}</p>}

              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lot #</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">New Qty</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {logItems.map((item) => (
                      <tr key={item.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(item.timestamp, true)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">{item.userEmail}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.itemName}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lotNumber}</td>
                        <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${getActionColor(item.action)}`}>{item.action}</td>
                        <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${getActionColor(item.action)}`}>{formatChange(item.quantityChange)}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.newQuantity}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.status}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };
        
        // --- NEW: Manage Accounts Component ---
        const ManageAccounts = ({ db, user, userRole }) => {
          const [users, setUsers] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          
          const roles = ['admin', 'technician', 'viewer'];

          useEffect(() => {
            if (!db || userRole !== 'admin') {
              setIsLoading(false);
              return;
            };
            
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const userList = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setUsers(userList);
              setIsLoading(false);
            }, (err) => {
              console.error("Error fetching users: ", err);
              setError("Failed to load user list.");
              setIsLoading(false);
            });

            return () => unsubscribe();
          }, [db, userRole]);
          
          const handleRoleChange = async (userId, newRole) => {
            if (userId === user.uid && newRole !== 'admin') {
              if (!window.confirm("Warning: You are about to remove your own admin status. Are you sure?")) {
                return; // Don't let admin demote themselves by accident
              }
            }
            
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
              await updateDoc(userDocRef, { role: newRole });
            } catch (err) {
              console.error("Error updating role: ", err);
            }
          };

          if (userRole !== 'admin') {
            return <div className="p-4 text-red-600">You do not have permission to view this page.</div>;
          }
          if (isLoading) return <p>Loading user accounts...</p>;
          if (error) return <p className="text-red-500">{error}</p>;

          return (
            <div className="p-4">
              <h2 className="text-2xl font-semibold text-gray-800 mb-4">Manage User Accounts</h2>
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Email</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User ID (UID)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {users.map((u) => (
                      <tr key={u.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{u.email}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{u.id}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <Select
                            id={`role-${u.id}`}
                            value={u.role}
                            onChange={(e) => handleRoleChange(u.id, e.target.value)}
                          >
                            {roles.map(r => <option key={r} value={r}>{r}</option>)}
                          </Select>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };
        
        
        // --- NEW: Auth Page Component ---
        const AuthPage = ({ auth, db }) => {
          const [isLoginView, setIsLoginView] = useState(true);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState(null);
          const [loading, setLoading] = useState(false);

          const handleAuthError = (err) => {
            switch (err.code) {
              case 'auth/user-not-found':
              case 'auth/wrong-password': setError('Invalid email or password.'); break;
              case 'auth/email-already-in-use': setError('This email address is already in use.'); break;
              case 'auth/weak-password': setError('Password is too weak. Must be at least 6 characters.'); break;
              default: setError('An unknown error occurred. Please try again.');
            }
            console.error("Auth Error: ", err);
          };
          
          // New User Document creation
          const createNewUserDocument = async (user) => {
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
              // Set default role to 'viewer'
              await setDoc(userDocRef, {
                email: user.email,
                role: 'viewer' 
              });
            } catch (err) {
              console.error("Error creating user role document: ", err);
            }
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError(null);
            try {
              if (isLoginView) {
                await signInWithEmailAndPassword(auth, email, password);
              } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // NEW: Create the user doc in Firestore
                await createNewUserDocument(userCredential.user);
              }
            } catch (err) {
              handleAuthError(err);
              setLoading(false);
            }
          };

          return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
              <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-lg shadow-md">
                <div><h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">{isLoginView ? 'Sign in to your account' : 'Create a new account'}</h2></div>
                <div className="flex border-b border-gray-200">
                  <button onClick={() => setIsLoginView(true)} className={`w-1/2 py-4 px-1 text-center text-sm font-medium ${isLoginView ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>Sign In</button>
                  <button onClick={() => setIsLoginView(false)} className={`w-1/2 py-4 px-1 text-center text-sm font-medium ${!isLoginView ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>Sign Up</button>
                </div>
                <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                  <Input label="Email address" id="email-address" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => setEmail(e.target.value)} />
                  <Input label="Password" id="password" name="password" type="password" autoComplete="current-password" required value={password} onChange={(e) => setPassword(e.target.value)} />
                  {error && <p className="text-red-600 text-sm text-center">{error}</p>}
                  <div><Button type="submit" variant="primary" className="w-full justify-center" disabled={loading}>{loading ? 'Processing...' : (isLoginView ? 'Sign In' : 'Create Account')}</Button></div>
                </form>
              </div>
            </div>
          );
        };


        // --- Main App Component ---
        function App() {
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [currentUser, setCurrentUser] = useState(null);
          const [userRole, setUserRole] = useState(null); // NEW: User Role state
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [currentPage, setCurrentPage] = useState('inventory'); 
          const [masterItems, setMasterItems] = useState([]);
          const [masterLoading, setMasterLoading] = useState(true);
          const [masterError, setMasterError] = useState(null);
          const [authError, setAuthError] = useState(null);

          // Initialize Firebase and Auth
          useEffect(() => {
            if (!window.firebase) {
              console.error("Firebase SDKs not loaded!");
              setAuthError("Failed to load Firebase SDKs.");
              setIsAuthReady(true); return;
            }
            try {
              const app = initializeApp(firebaseConfig);
              const authInstance = getAuth(app);
              const dbInstance = getFirestore(app);
              setAuth(authInstance);
              setDb(dbInstance);

              const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                  // User is signed in. Fetch their role.
                  const userDocRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                  const userDoc = await getDoc(userDocRef);
                  
                  if (userDoc.exists()) {
                    setUserRole(userDoc.data().role);
                  } else {
                    // This is a failsafe, but signup *should* create this doc.
                    // This is useful for the Super Admin you created manually
                    if (userDoc.data() && userDoc.data().role) {
                       setUserRole(userDoc.data().role);
                    } else {
                       // If doc truly doesn't exist, create it.
                       try {
                         await setDoc(userDocRef, { email: user.email, role: 'viewer' });
                         setUserRole('viewer');
                       } catch (e) {
                         console.error("Error creating user doc on the fly: ", e);
                       }
                    }
                  }
                  setCurrentUser(user);
                  setAuthError(null);
                } else {
                  // User is signed out
                  setCurrentUser(null);
                  setUserRole(null);
                }
                setIsAuthReady(true);
              });
              return () => unsubscribe();
              
            } catch (e) {
              console.error("Error initializing Firebase: ", e);
              setAuthError("Failed to initialize database. Check Firebase config.");
              setIsAuthReady(true); 
            }
          }, []);

          // Fetch Master List
          useEffect(() => {
            if (!isAuthReady || !db || !currentUser) {
                if (currentUser === null) setMasterLoading(false);
                return;
            }
            setMasterLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'masterList');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMasterItems(items);
              setMasterLoading(false);
            }, (err) => {
              console.error("Error fetching master list: ", err);
              setMasterError("Failed to load master list.");
              setMasterLoading(false);
            });
            return () => unsubscribe();
          }, [db, isAuthReady, currentUser]);
          
          const handleSignOut = async () => {
            if (auth) {
              try { await signOut(auth); } catch (err) { console.error("Error signing out: ", err); }
            }
          };

          const NavButton = ({ page, label, icon }) => (
            <button
              onClick={() => setCurrentPage(page)}
              className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium ${
                currentPage === page ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'
              }`}
            >
              {icon}
              {label}
            </button>
          );
          
          const masterItemMap = useMemo(() => {
            return masterItems.reduce((acc, item) => {
              acc[item.id] = item;
              return acc;
            }, {});
          }, [masterItems]);
          
          // --- Main Render Logic ---
          if (!isAuthReady) {
             return <div id="loading">Connecting to your lab inventory...</div>
          }
          if (authError) {
             return (
                <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4" role="alert">
                  <p className="font-bold">Connection Error</p><p>{authError}</p>
                </div>
              );
          }
          if (!currentUser || !userRole) {
            // User is not logged in, or role is still being fetched
            // Show login page, but also handle loading state for role
            if (!currentUser) {
              return <AuthPage auth={auth} db={db} />
            }
            return <div id="loading">Loading user permissions...</div>
          }

          // If we are here, user is logged in AND role is set
          const PageContent = () => {
            switch(currentPage) {
              case 'inventory':
                return <ActiveInventory db={db} user={currentUser} userRole={userRole} masterItems={masterItems} />;
              case 'master':
                return <MasterList db={db} user={currentUser} userRole={userRole} masterItems={masterItems} isLoading={masterLoading} error={masterError} />;
              case 'log':
                return <InventoryLog db={db} masterItemMap={masterItemMap} />;
              case 'admin':
                return <ManageAccounts db={db} user={currentUser} userRole={userRole} />;
              default:
                return <ActiveInventory db={db} user={currentUser} userRole={userRole} masterItems={masterItems} />;
            }
          };

          return (
            <div className="min-h-screen font-sans">
              <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center h-16">
                    <div className="flex items-center gap-3">
                      <IconClipboard />
                      <h1 className="text-xl font-semibold text-gray-900">Shared Lab Manager (Cloud)</h1>
                    </div>
                    <nav className="flex space-x-2">
                      <NavButton page="inventory" label="Active Inventory" icon={<IconClipboard />} />
                      <NavButton page="master" label="Master List" icon={<IconEdit />} />
                      <NavButton page="log" label="Inventory Log" icon={<IconHistory />} />
                      {/* --- PERMISSION CHECK --- */}
                      {userRole === 'admin' && (
                        <NavButton page="admin" label="Manage Accounts" icon={<IconAdmin />} />
                      )}
                    </nav>
                    <div className="flex items-center gap-4">
                      <div className="text-sm font-medium text-gray-600">
                        User: <span className="font-bold text-blue-600">{currentUser.email}</span> (<span className="italic">{userRole}</span>)
                      </div>
                      <Button onClick={handleSignOut} variant="secondary" className="px-3 py-1.5">
                        <IconSignOut /> Sign Out
                      </Button>
                    </div>
                  </div>
                </div>
              </header>
              <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <PageContent />
              </main>
            </div>
          );
        }

        // 6. Render the App
        const checkFirebase = setInterval(() => {
          if (window.firebase) {
            clearInterval(checkFirebase);
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
          }
        }, 100);

    </script>
</body>
</html>

