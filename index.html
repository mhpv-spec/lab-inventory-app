<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Inventory Manager (cons-593c6)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 3. Load Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Load Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
        getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
        signInWithEmailAndPassword, signOut
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
        onSnapshot, collection, query, setLogLevel, serverTimestamp, orderBy, getDoc
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.firebase = {
        app: { initializeApp },
        auth: { 
          getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
          signInWithEmailAndPassword, signOut
        },
        firestore: {
          getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
          collection, query, setLogLevel, serverTimestamp, orderBy, getDoc
        }
      };
    </script>
    
    <!-- 5. *** NEW *** Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- 6. Load Google Fonts (Inter for EN, Vazirmatn for FA) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      /* Apply Vazirmatn font when in Farsi */
      [lang="fa"] body { font-family: 'Vazirmatn', sans-serif; }
      /* Default font */
      body { font-family: 'Inter', sans-serif; }
      #loading {
        display: flex; justify-content: center; align-items: center;
        height: 100vh; font-size: 1.2rem; font-weight: 500; color: #333;
      }
      button:disabled, select:disabled { cursor: not-allowed; opacity: 0.6; }
      /* RTL support */
      .text-start { text-align: left; }
      .text-end { text-align: right; }
      [dir="rtl"] .text-start { text-align: right; }
      [dir="rtl"] .text-end { text-align: left; }
      .ms-2 { margin-left: 0.5rem; }
      .me-2 { margin-right: 0.5rem; }
      [dir="rtl"] .ms-2 { margin-left: 0; margin-right: 0.5rem; }
      [dir="rtl"] .me-2 { margin-right: 0; margin-left: 0.5rem; }
      .gap-2 { gap: 0.5rem; }
      .gap-3 { gap: 0.75rem; }
      .gap-4 { gap: 1rem; }
      .ps-4 { padding-left: 1rem; }
      .pe-4 { padding-right: 1rem; }
      [dir="rtl"] .ps-4 { padding-left: 0; padding-right: 1rem; }
      [dir="rtl"] .pe-4 { padding-right: 0; padding-left: 1rem; }
    </style>
</head>
<body class="bg-gray-100">
    
    <div id="root">
        <div id="loading">Connecting to your lab inventory...</div>
    </div>

    <!-- 6. React App Code (transpiled by Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyACGODYoAc5Yc7dzX8aYlX8t-UhPUyy9oM",
          authDomain: "cons-593c6.firebaseapp.com",
          projectId: "cons-593c6",
          storageBucket: "cons-593c6.firebasestorage.app",
          messagingSenderId: "674188672813",
          appId: "1:674188672813:web:887caed5ea2fc927fbdda4",
          measurementId: "G-TK88H80GYC"
        };
        const appId = "cons-593c6"; 
        
        // --- Destructure Firebase from window ---
        const { initializeApp } = window.firebase.app;
        const { 
          getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
          signInWithEmailAndPassword, signOut
        } = window.firebase.auth;
        const { 
          getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
          onSnapshot, collection, query, setLogLevel, serverTimestamp, orderBy, getDoc
        } = window.firebase.firestore;
        // NEW: Get Chart.js from window
        const Chart = window.Chart;

        // --- 1. TRANSLATION DICTIONARY ---
        const translations = {
          en: {
            app: {
              title: "Shared Lab Manager (Cloud)",
              loading: "Connecting to your lab inventory...",
              loadingPermissions: "Loading user permissions...",
              user: "User",
              signOut: "Sign Out",
              connectionError: "Connection Error",
              authError: "Failed to initialize database. Check Firebase config.",
            },
            nav: {
              dashboard: "Dashboard", // New
              inventory: "Active Inventory",
              masterList: "Master List",
              log: "Inventory Log",
              admin: "Manage Accounts",
              labs: "Manage Labs"
            },
            dashboard: { // New
              title: "Inventory Dashboard",
              consumptionTitle: "Monthly Consumption (Last 12 Months)",
              consumptionLabel: "Items Used",
              statusTitle: "Current Stock by Status",
              filterLab: "Filter by Lab",
              filterItem: "Filter by Item",
              allLabs: "All Labs",
              allItems: "All Items",
              noData: "No consumption data found for this period."
            },
            auth: {
              signInTitle: "Sign in to your account",
              signUpTitle: "Create a new account",
              signIn: "Sign In",
              signUp: "Sign Up",
              email: "Email address",
              password: "Password",
              processing: "Processing...",
              createAccount: "Create Account",
              error: {
                invalid: "Invalid email or password.",
                inUse: "This email address is already in use.",
                weakPass: "Password is too weak. Must be at least 6 characters.",
                unknown: "An unknown error occurred. Please try again."
              }
            },
            masterList: {
              title: "Master Consumable List",
              export: "Export to CSV",
              addNew: "Add New Master Item",
              loading: "Loading master list...",
              error: "Failed to load master list.",
              header: {
                id: "Item ID",
                category: "Category",
                name: "Name & Specification",
                suppliers: "Approved Suppliers",
                verification: "Verification",
                lowStock: "Low Stock",
                actions: "Actions"
              },
              deleteConfirm: "Are you sure you want to delete this master item?",
              modal: {
                editTitle: "Edit Master Item",
                addTitle: "Add New Master Item",
                id: "Item ID (e.g., SP-001)",
                category: "Category",
                name: "Name & Specification",
                suppliers: "Approved Suppliers",
                verification: "Acceptance / Verification Action",
                lowStock: "Low Stock Threshold",
                cancel: "Cancel",
                save: "Save Changes",
                add: "Add Item"
              },
              categories: ['Sample Prep', 'Chemical Analysis', 'General Lab']
            },
            inventory: {
              title: "Active Inventory",
              addNew: "Add New Stock",
              noMasterItem: "Please add at least one item to the **Master Consumable List** before adding stock.",
              noLab: "Please add at least one lab in **Manage Labs** before adding stock.", 
              lowStockWarn: "Low Stock Warning",
              lowStockMsg: "Currently {quantity} in stock (threshold is {threshold}).",
              loading: "Loading inventory...",
              error: "Failed to load inventory.",
              header: {
                name: "Item Name",
                lot: "Lot #",
                lab: "Lab",
                received: "Received",
                expires: "Expires",
                quantity: "Quantity",
                location: "Location",
                status: "Status",
                actions: "Actions"
              },
              status: {
                approved: "Approved for Use",
                quarantined: "Quarantined",
                disposed: "Disposed",
                expired: "Expired"
              },
              take: "Take",
              deleteConfirm: "Are you sure you want to delete Lot {lotNumber}? This action will be logged.",
              modal: {
                editTitle: "Edit Inventory Item",
                addTitle: "Add New Stock Item",
                masterItem: "Master Item",
                selectItem: "Select an approved item",
                lab: "Lab",
                selectLab: "Select a lab",
                lot: "Lot / Batch Number",
                received: "Date Received",
                expires: "Expiration Date",
                quantity: "Quantity",
                location: "Storage Location",
                status: "Status",
                cancel: "Cancel",
                save: "Save Changes",
                add: "Add Item"
              },
              takeModal: {
                title: "Take Stock",
                inStock: "Currently in Stock:",
                quantity: "Quantity to Take:",
                errorZero: "Amount must be greater than zero.",
                errorMore: "Amount cannot be more than the {quantity} in stock.",
                confirm: "Confirm & Log"
              }
            },
            log: {
              title: "Inventory Log",
              export: "Export to CSV",
              loading: "Loading log...",
              error: "Failed to load inventory log.",
              header: {
                timestamp: "Timestamp",
                userEmail: "User",
                itemName: "Item Name",
                lotNumber: "Lot #",
                labName: "Lab",
                action: "Action",
                quantityChange: "Change",
                newQuantity: "New Qty",
                status: "Status"
              },
              actions: {
                added: "Stock Added",
                used: "Stock Used",
                correction: "Stock Used/Correction",
                status: "Status Change",
                new: "New Item Added",
                deleted: "Item Deleted"
              }
            },
            admin: {
              title: "Manage User Accounts",
              noPermission: "You do not have permission to view this page.",
              loading: "Loading user accounts...",
              error: "Failed to load user list.",
              header: {
                email: "User Email",
                uid: "User ID (UID)",
                role: "Role"
              },
              demoteWarning: "Warning: You are about to remove your own admin status. Are you sure?",
              roles: {
                admin: "Admin",
                technician: "Technician",
                viewer: "Viewer"
              }
            },
            labs: {
              title: "Manage Labs",
              addNew: "Add New Lab",
              loading: "Loading labs...",
              error: "Failed to load labs.",
              header: {
                name: "Lab Name",
                actions: "Actions"
              },
              deleteConfirm: "Are you sure you want to delete the '{labName}' lab?",
              modal: {
                editTitle: "Edit Lab Name",
                addTitle: "Add New Lab",
                name: "Lab Name (e.g., Metals Lab)",
                cancel: "Cancel",
                save: "Save Changes",
                add: "Add Lab"
              }
            }
          },
          fa: {
            app: {
              title: "مدیر آزمایشگاه (ابری)",
              loading: "در حال اتصال به انبار آزمایشگاه...",
              loadingPermissions: "در حال بارگذاری دسترسی‌های کاربر...",
              user: "کاربر",
              signOut: "خروج",
              connectionError: "خطای اتصال",
              authError: "مقداردهی اولیه پایگاه داده ناموفق بود. تنظیمات Firebase را بررسی کنید.",
            },
            nav: {
              dashboard: "داشبورد", // New
              inventory: "موجودی فعال",
              masterList: "لیست اصلی",
              log: "گزارش انبار",
              admin: "مدیریت حساب‌ها",
              labs: "مدیریت آزمایشگاه‌ها"
            },
            dashboard: { // New
              title: "داشبورد انبار",
              consumptionTitle: "مصرف ماهانه (۱۲ ماه گذشته)",
              consumptionLabel: "موارد مصرف شده",
              statusTitle: "موجودی فعلی بر اساس وضعیت",
              filterLab: "فیلتر بر اساس آزمایشگاه",
              filterItem: "فیلتر بر اساس کالا",
              allLabs: "همه آزمایشگاه‌ها",
              allItems: "همه کالاها",
              noData: "داده‌ای برای این دوره یافت نشد."
            },
            auth: {
              signInTitle: "ورود به حساب کاربری",
              signUpTitle: "ایجاد حساب کاربری جدید",
              signIn: "ورود",
              signUp: "ثبت نام",
              email: "آدرس ایمیل",
              password: "رمز عبور",
              processing: "در حال پردازش...",
              createAccount: "ایجاد حساب",
              error: {
                invalid: "ایمیل یا رمز عبور نامعتبر است.",
                inUse: "این آدرس ایمیل قبلاً استفاده شده است.",
                weakPass: "رمز عبور ضعیف است. باید حداقل ۶ کاراکتر باشد.",
                unknown: "خطایی ناشناخته رخ داد. لطفاً دوباره تلاش کنید."
              }
            },
            masterList: {
              title: "لیست اصلی مواد مصرفی",
              export: "خروجی CSV",
              addNew: "افزودن آیتم اصلی جدید",
              loading: "در حال بارگذاری لیست اصلی...",
              error: "بارگذاری لیست اصلی ناموفق بود.",
              header: {
                id: "کد کالا",
                category: "دسته‌بندی",
                name: "نام و مشخصات",
                suppliers: "تامین‌کنندگان تایید شده",
                verification: "تاییدیه",
                lowStock: "حد انبار",
                actions: "عملیات"
              },
              deleteConfirm: "آیا از حذف این آیتم اصلی مطمئن هستید؟",
              modal: {
                editTitle: "ویرایش آیتم اصلی",
                addTitle: "افزودن آیتم اصلی جدید",
                id: "کد کالا (مثال: SP-001)",
                category: "دسته‌بندی",
                name: "نام و مشخصات",
                suppliers: "تامین‌کنندگان تایید شده",
                verification: "اقدام پذیرش / تایید",
                lowStock: "آستانه کمبود موجودی",
                cancel: "لغو",
                save: "ذخیره تغییرات",
                add: "افزودن آیتم"
              },
              categories: ['آماده‌سازی نمونه', 'آنالیز شیمیایی', 'عمومی آزمایشگاه']
            },
            inventory: {
              title: "موجودی فعال",
              addNew: "افزودن موجودی جدید",
              noMasterItem: "لطفاً قبل از افزودن موجودی، حداقل یک آیتم به **لیست اصلی** اضافه کنید.",
              noLab: "لطفاً قبل از افزودن موجودی، حداقل یک آزمایشگاه در **مدیریت آزمایشگاه‌ها** تعریف کنید.",
              lowStockWarn: "هشدار کمبود موجودی",
              lowStockMsg: "در حال حاضر {quantity} عدد موجود است (آستانه {threshold} است).",
              loading: "در حال بارگذاری موجودی...",
              error: "بارگذاری موجودی ناموفق بود.",
              header: {
                name: "نام کالا",
                lot: "شماره لات",
                lab: "آزمایشگاه",
                received: "دریافت",
                expires: "انقضا",
                quantity: "تعداد",
                location: "محل نگهداری",
                status: "وضعیت",
                actions: "عملیات"
              },
              status: {
                approved: "آماده استفاده",
                quarantined: "قرنطینه",
                disposed: "اسقاط شده",
                expired: "منقضی شده"
              },
              take: "برداشت",
              deleteConfirm: "آیا از حذف لات {lotNumber} مطمئن هستید؟ این عملیات ثبت خواهد شد.",
              modal: {
                editTitle: "ویرایش آیتم موجودی",
                addTitle: "افزودن موجودی جدید",
                masterItem: "آیتم اصلی",
                selectItem: "یک آیتم تایید شده را انتخاب کنید",
                lab: "آزمایشگاه",
                selectLab: "یک آزمایشگاه را انتخاب کنید",
                lot: "شماره لات / بچ",
                received: "تاریخ دریافت",
                expires: "تاریخ انقضا",
                quantity: "تعداد",
                location: "محل نگهداری",
                status: "وضعیت",
                cancel: "لغو",
                save: "ذخیره تغییرات",
                add: "افزودن آیتم"
              },
              takeModal: {
                title: "برداشت از موجودی",
                inStock: "موجودی فعلی:",
                quantity: "تعداد برداشتی:",
                errorZero: "تعداد باید بیشتر از صفر باشد.",
                errorMore: "تعداد برداشتی نمی‌تواند از {quantity} موجود بیشتر باشد.",
                confirm: "تایید و ثبت"
              }
            },
            log: {
              title: "گزارش انبار",
              export: "خروجی CSV",
              loading: "در حال بارگذاری گزارش...",
              error: "بارگذاری گزارش ناموفق بود.",
              header: {
                timestamp: "زمان",
                userEmail: "کاربر",
                itemName: "نام کالا",
                lotNumber: "شماره لات",
                labName: "آزمایشگاه",
                action: "عملیات",
                quantityChange: "تغییر",
                newQuantity: "موجودی جدید",
                status: "وضعیت"
              },
              actions: {
                added: "افزایش موجودی",
                used: "برداشت موجودی",
                correction: "برداشت/اصلاح موجودی",
                status: "تغییر وضعیت",
                new: "افزودن آیتم جدید",
                deleted: "حذف آیتم"
              }
            },
            admin: {
              title: "مدیریت حساب‌های کاربری",
              noPermission: "شما اجازه دسترسی به این صفحه را ندارید.",
              loading: "در حال بارگذاری حساب‌های کاربری...",
              error: "بارگذاری لیست کاربران ناموفق بود.",
              header: {
                email: "ایمیل کاربر",
                uid: "شناسه کاربری (UID)",
                role: "نقش"
              },
              demoteWarning: "هشدار: شما در حال حذف دسترسی ادمین خود هستید. آیا مطمئن هستید؟",
              roles: {
                admin: "ادمین",
                technician: "تکنسین",
                viewer: "ناظر"
              }
            },
            labs: {
              title: "مدیریت آزمایشگاه‌ها",
              addNew: "افزودن آزمایشگاه جدید",
              loading: "در حال بارگذاری آزمایشگاه‌ها...",
              error: "بارگذاری آزمایشگاه‌ها ناموفق بود.",
              header: {
                name: "نام آزمایشگاه",
                actions: "عملیات"
              },
              deleteConfirm: "آیا از حذف آزمایشگاه '{labName}' مطمئن هستید؟",
              modal: {
                editTitle: "ویرایش نام آزمایشگاه",
                addTitle: "افزودن آزمایشگاه جدید",
                name: "نام آزمایشگاه (مثال: آزمایشگاه فلزات)",
                cancel: "لغو",
                save: "ذخیره تغییرات",
                add: "افزودن"
              }
            }
          }
        };

        // --- 2. LANGUAGE CONTEXT & PROVIDER ---
        const LangContext = createContext();
        const LangProvider = ({ children }) => {
          const [language, setLanguage] = useState('en'); 
          useEffect(() => {
            document.documentElement.dir = language === 'fa' ? 'rtl' : 'ltr';
            document.documentElement.lang = language;
          }, [language]);
          const t = useCallback((key, params = {}) => {
            const keys = key.split('.');
            let result = translations[language];
            try {
              for (const k of keys) { result = result[k]; }
              if (typeof result === 'string') {
                return result.replace(/\{(\w+)\}/g, (_, paramName) => params[paramName] || '');
              }
              return result;
            } catch (e) {
              try {
                let fallback = translations['en'];
                for (const k of keys) { fallback = fallback[k]; }
                if (typeof fallback === 'string') {
                  return fallback.replace(/\{(\w+)\}/g, (_, paramName) => params[paramName] || '');
                }
                return fallback || key;
              } catch (e2) { return key; }
            }
          }, [language]);
          return (
            <LangContext.Provider value={{ language, setLanguage, t }}>
              {children}
            </LangContext.Provider>
          );
        };
        const useLang = () => useContext(LangContext);
        
        // --- Helper Functions & Constants ---
        const formatDate = (dateInput, includeTime = false) => {
          if (!dateInput) return 'N/A';
          let date;
          if (dateInput && dateInput.toDate) { date = dateInput.toDate(); } 
          else if (typeof dateInput === 'string') { date = new Date(dateInput); } 
          else { date = dateInput; }
          if (!date || isNaN(date.getTime())) return 'N/A';
          const locale = document.documentElement.lang === 'fa' ? 'fa-IR' : 'en-US';
          const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', calendar: locale === 'fa-IR' ? 'persian' : 'gregory' };
          const timeOptions = { hour: '2-digit', minute: '2-digit' };
          let formattedDate;
          if (includeTime) {
            formattedDate = date.toLocaleString(locale, {...dateOptions, ...timeOptions});
          } else {
            formattedDate = date.toLocaleDateString(locale, dateOptions);
          }
          return formattedDate.replace(',', ''); 
        };
        
        const sanitizeForCSV = (value) => {
          if (value == null) return '';
          let strValue = String(value);
          if (strValue.search(/("|,|\n)/g) >= 0) {
            strValue = strValue.replace(/"/g, '""');
            return `"${strValue}"`;
          }
          return strValue;
        };

        const exportToCSV = (data, headers, filename, t) => {
          const csvRows = [];
          const translatedHeaders = headers.map(h => {
             return t(`log.header.${h}`) || t(`masterList.header.${h}`) || t(`inventory.header.${h}`) || h;
          });
          csvRows.push(translatedHeaders.map(sanitizeForCSV).join(','));
          for (const item of data) {
            const values = headers.map(headerKey => {
              if (headerKey === 'itemName' && item.masterItem) {
                 return sanitizeForCSV(`${item.masterItem.itemId} - ${item.masterItem.nameAndSpec}`);
              }
              if (headerKey === 'timestamp' && item.timestamp) {
                 return sanitizeForCSV(formatDate(item.timestamp, true));
              }
              if (headerKey === 'userEmail' && item.userEmail) {
                return sanitizeForCSV(item.userEmail);
              }
              if (headerKey === 'status') {
                const statusKey = Object.keys(translations.en.inventory.status).find(key => translations.en.inventory.status[key] === item.status);
                return sanitizeForCSV(t(`inventory.status.${statusKey}`) || item.status);
              }
              if (headerKey === 'action') {
                 const actionKey = Object.keys(translations.en.log.actions).find(key => translations.en.log.actions[key] === item.action);
                return sanitizeForCSV(t(`log.actions.${actionKey}`) || item.action);
              }
              if (headerKey === 'category') {
                const catKey = Object.keys(translations.en.masterList.categories).find(key => translations.en.masterList.categories[key] === item.category);
                return sanitizeForCSV(t(`masterList.categories.${catKey}`) || item.category);
              }
              if (headerKey === 'labName' && item.labName) {
                return sanitizeForCSV(item.labName);
              }
              return sanitizeForCSV(item[headerKey]);
            });
            csvRows.push(values.join(','));
          }
          const csvString = csvRows.join('\n');
          const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          const blob = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        };

        // --- Inline SVG Icons ---
        const IconPlus = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const IconTrash = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
        const IconEdit = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>);
        const IconClipboard = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>);
        const IconHistory = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>);
        const IconDownload = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>);
        const IconMinus = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const IconSignOut = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const IconX = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const IconAlertTriangle = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500 inline-block me-1"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        const IconAdmin = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        const IconGlobe = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>);
        const IconLab = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.3a1 1 0 0 1-1.7.7L6 8l-2.3 2.3a1 1 0 0 1-1.7-.7V2"></path><path d="M14 2v7.3a1 1 0 0 0 1.7.7L18 8l2.3 2.3a1 1 0 0 0 1.7-.7V2"></path><path d="M8 22h8"></path><path d="M7 15h10"></path><path d="M10 15v7"></path><path d="M14 15v7"></path></svg>);
        const IconDashboard = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"></rect><line x1="9" x2="9" y1="3" y2="21"></line><line x1="15" x2="15" y1="3" y2="21"></line><line x1="3" x2="21" y1="9"></line><line x1="3" x2="21" y1="15"></line></svg>);


        // --- Reusable UI Components ---
        const Modal = ({ isOpen, onClose, title, children, allowClose = true }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" aria-modal="true" role="dialog">
              <div className="relative w-full max-w-2xl bg-white rounded-lg shadow-xl m-4">
                <div className="flex items-center justify-between p-4 border-b rounded-t">
                  <h3 className="text-xl font-semibold text-gray-900">{title}</h3>
                  {allowClose && (
                    <button type="button" className="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ms-auto inline-flex items-center" onClick={onClose} aria-label="Close modal">
                      <IconX />
                    </button>
                  )}
                </div>
                <div className="p-6 space-y-6">{children}</div>
              </div>
            </div>
          );
        };
        
        const TakeStockModal = ({ isOpen, onClose, item, onConfirm }) => {
          const { t } = useLang();
          const [takeAmount, setTakeAmount] = useState(1);
          const [error, setError] = useState('');
          const masterItem = item?.masterItem || {};
          const currentQty = item?.quantity || 0;

          const handleSubmit = (e) => {
            e.preventDefault();
            const amount = Number(takeAmount);
            if (amount <= 0) { setError(t('inventory.takeModal.errorZero')); return; }
            if (amount > currentQty) { setError(t('inventory.takeModal.errorMore', {quantity: currentQty})); return; }
            onConfirm(amount);
          };
          
          useEffect(() => { if (isOpen) { setTakeAmount(1); setError(''); } }, [isOpen]);

          return (
            <Modal isOpen={isOpen} onClose={onClose} title={t('inventory.takeModal.title')} allowClose={true}>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <h4 className="font-medium text-gray-800">{masterItem.itemId} - {masterItem.nameAndSpec}</h4>
                  <p className="text-sm text-gray-600">{t('inventory.header.lot')}: {item?.lotNumber}</p>
                  <p className="text-sm text-gray-600">{t('inventory.takeModal.inStock')} <span className="font-bold">{currentQty}</span></p>
                </div>
                <Input label={t('inventory.takeModal.quantity')} id="takeAmount" name="takeAmount" type="number" min="1" max={currentQty} value={takeAmount} onChange={(e) => setTakeAmount(e.target.value)} required autoFocus />
                {error && <p className="text-red-600 text-sm">{error}</p>}
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button type="button" variant="secondary" onClick={onClose}>{t('masterList.modal.cancel')}</Button>
                  <Button type="submit" variant="primary">{t('inventory.takeModal.confirm')}</Button>
                </div>
              </form>
            </Modal>
          );
        };

        const Input = ({ label, id, ...props }) => (
          <div>
            <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900 text-start">{label}</label>
            <input id={id} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed" {...props} />
          </div>
        );

        const Select = ({ label, id, children, ...props }) => (
          <div>
            <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900 text-start">{label}</label>
            <select id={id} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed" {...props}>
              {children}
            </select>
          </div>
        );

        const Button = ({ children, onClick, variant = 'primary', type = 'button', ...props }) => {
          const baseStyle = "px-4 py-2 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed";
          const variants = {
            primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
            danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
            secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
            warning: 'bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400'
          };
          return (
            <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]}`} {...props}>
              {children}
            </button>
          );
        };

        // --- Log Helper Function ---
        const logChange = async (db, user, item, actionKey, quantityChange, newQuantity, newStatus = null) => {
          if (!db || !appId || !user || !user.uid || !user.email) {
            console.error("Log failed: DB, AppID, or User missing.");
            return;
          }
          const logCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventoryLog');
          const masterItem = item.masterItem || { itemId: 'N/A', nameAndSpec: 'N/A' };
          const action = translations['en'].log.actions[actionKey] || actionKey;
          
          const logEntry = {
            timestamp: serverTimestamp(),
            userId: user.uid, 
            userEmail: user.email,
            inventoryItemId: item.id || 'N/A',
            masterItemId: item.masterItemId,
            itemName: `${masterItem.itemId} - ${masterItem.nameAndSpec}`,
            lotNumber: item.lotNumber,
            labId: item.labId || 'N/A', 
            labName: item.labName || 'N/A', 
            action: action, 
            quantityChange: quantityChange,
            newQuantity: newQuantity,
            status: newStatus || item.status,
          };
          try { await addDoc(logCollectionRef, logEntry); } 
          catch (err) { console.error("Error writing to log: ", err); }
        };

        // --- Master List Component ---
        const MasterList = ({ db, user, userRole, masterItems, isLoading, error }) => {
          const { t } = useLang();
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [currentItemId, setCurrentItemId] = useState(null);
          const [form, setForm] = useState({
            itemId: '', category: 'Sample Prep', nameAndSpec: '',
            approvedSuppliers: '', verificationAction: '', lowStockThreshold: 3,
          });

          const categories = t('masterList.categories');
          const canManage = userRole === 'admin';

          const resetForm = () => {
            setForm({
              itemId: '', category: categories[0], nameAndSpec: '',
              approvedSuppliers: '', verificationAction: '', lowStockThreshold: 3,
            });
            setIsEditing(false);
            setCurrentItemId(null);
          };

          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (item) => {
            setForm({
              itemId: item.itemId, category: item.category, nameAndSpec: item.nameAndSpec,
              approvedSuppliers: item.approvedSuppliers, verificationAction: item.verificationAction,
              lowStockThreshold: item.lowStockThreshold || 3,
            });
            setIsEditing(true);
            setCurrentItemId(item.id);
            setIsModalOpen(true);
          };
          const closeModal = () => { setIsModalOpen(false); resetForm(); };
          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setForm((prev) => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !canManage) return;
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'masterList');
              if (isEditing) { await setDoc(doc(collectionRef, currentItemId), form); } 
              else { await addDoc(collectionRef, form); }
              closeModal();
            } catch (err) { console.error("Error saving master item: ", err); }
          };

          const handleDelete = async (docId) => {
            if (!canManage || !window.confirm(t('masterList.deleteConfirm'))) return;
            if (!db) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'masterList', docId)); } 
            catch (err) { console.error("Error deleting item: ", err); }
          };
          
          const handleExport = () => {
            const headers = ['itemId', 'category', 'nameAndSpec', 'approvedSuppliers', 'verificationAction', 'lowStockThreshold'];
            exportToCSV(masterItems, headers, 'master-consumable-list.csv', t);
          };

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('masterList.title')}</h2>
                <div className="flex gap-2">
                  <Button onClick={handleExport} variant="secondary">
                    <IconDownload /> {t('masterList.export')}
                  </Button>
                  {canManage && (
                    <Button onClick={openAddModal} variant="primary">
                      <IconPlus /> {t('masterList.addNew')}
                    </Button>
                  )}
                </div>
              </div>

              {isLoading && <p>{t('masterList.loading')}</p>}
              {error && <p className="text-red-500">{t('masterList.error')}</p>}
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.id')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.category')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.name')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.suppliers')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.modal.verification')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.modal.lowStock')}</th>
                      {canManage && <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.actions')}</th>}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {masterItems.map((item) => (
                      <tr key={item.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.itemId}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{categories.includes(item.category) ? item.category : categories[0]}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.nameAndSpec}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.approvedSuppliers}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.verificationAction}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lowStockThreshold || 3}</td>
                        {canManage && (
                          <td className="px-6 py-4 whitespace-nowrap text-end text-sm font-medium">
                            <div className="flex justify-end gap-2">
                              <Button variant="secondary" onClick={() => openEditModal(item)} aria-label="Edit"><IconEdit /></Button>
                              <Button variant="danger" onClick={() => handleDelete(item.id)} aria-label="Delete"><IconTrash /></Button>
                            </div>
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? t('masterList.modal.editTitle') : t('masterList.modal.addTitle')} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <Input label={t('masterList.modal.id')} id="itemId" name="itemId" value={form.itemId} onChange={handleChange} required />
                  <Select label={t('masterList.modal.category')} id="category" name="category" value={form.category} onChange={handleChange}>
                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </Select>
                  <Input label={t('masterList.modal.name')} id="nameAndSpec" name="nameAndSpec" value={form.nameAndSpec} onChange={handleChange} required />
                  <Input label={t('masterList.modal.suppliers')} id="approvedSuppliers" name="approvedSuppliers" value={form.approvedSuppliers} onChange={handleChange} />
                  <Input label={t('masterList.modal.verification')} id="verificationAction" name="verificationAction" value={form.verificationAction} onChange={handleChange} />
                  <Input label={t('masterList.modal.lowStock')} id="lowStockThreshold" name="lowStockThreshold" type="number" min="0" value={form.lowStockThreshold} onChange={handleChange} />
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>{t('masterList.modal.cancel')}</Button>
                    <Button type="submit" variant="primary">{isEditing ? t('masterList.modal.save') : t('masterList.modal.add')}</Button>
                  </div>
                </form>
              </Modal>
            </div>
          );
        };

        // --- Active Inventory Component ---
        const ActiveInventory = ({ db, user, userRole, masterItems, labs, labMap }) => {
          const { t } = useLang();
          const [inventoryItems, setInventoryItems] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [isTakeModalOpen, setIsTakeModalOpen] = useState(false);
          const [currentItem, setCurrentItem] = useState(null); 
          const [form, setForm] = useState({
            masterItemId: '', lotNumber: '', dateReceived: '', expirationDate: '',
            quantity: 1, storageLocation: '', status: 'Approved for Use', labId: ''
          });
          
          const statuses = Object.keys(t('inventory.status')).map(key => t(`inventory.status.${key}`));
          const canManage = ['admin', 'technician'].includes(userRole);

          const masterItemMap = useMemo(() => {
            return masterItems.reduce((acc, item) => {
              acc[item.id] = item;
              return acc;
            }, {});
          }, [masterItems]);
          
          const populatedInventory = useMemo(() => {
            return inventoryItems.map(item => ({
              ...item,
              masterItem: masterItemMap[item.masterItemId] || { itemId: 'N/A', nameAndSpec: 'N/A' },
              labName: labMap[item.labId]?.name || 'N/A'
            }))
          }, [inventoryItems, masterItemMap, labMap]);

          useEffect(() => {
            if (!db) return;
            setIsLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setInventoryItems(items);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching inventory: ", err); setError(t('inventory.error')); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, user.uid, t]);

          const resetForm = () => {
            setForm({
              masterItemId: masterItems.length > 0 ? masterItems[0].id : '', 
              lotNumber: '', dateReceived: '',
              expirationDate: '', quantity: 1, storageLocation: '', 
              status: t('inventory.status.approved'),
              labId: labs.length > 0 ? labs[0].id : ''
            });
            setIsEditing(false);
            setCurrentItem(null);
          };

          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (item) => {
            setForm({
              masterItemId: item.masterItemId, lotNumber: item.lotNumber, dateReceived: item.dateReceived,
              expirationDate: item.expirationDate, quantity: item.quantity,
              storageLocation: item.storageLocation, status: item.status,
              labId: item.labId
            });
            setIsEditing(true);
            setCurrentItem(item); 
            setIsModalOpen(true);
          };
          const openTakeModal = (item) => { setCurrentItem(item); setIsTakeModalOpen(true); };
          const closeModal = () => { setIsModalOpen(false); setIsTakeModalOpen(false); resetForm(); };

          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setForm((prev) => ({ ...prev, [name]: type === 'number' ? Number(value) : value, }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !user || !canManage) return;
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
              const itemForLog = {
                 ...form,
                 masterItem: masterItemMap[form.masterItemId],
                 labName: labMap[form.labId]?.name || 'N/A'
              };
              
              if (isEditing) {
                const docRef = doc(collectionRef, currentItem.id);
                await setDoc(docRef, form);
                const oldQty = currentItem.quantity; const newQty = form.quantity;
                const oldStatus = currentItem.status; const newStatus = form.status;
                if (oldQty !== newQty) {
                  const change = newQty - oldQty;
                  const actionKey = change > 0 ? "added" : "correction";
                  await logChange(db, user, {...currentItem, ...itemForLog}, actionKey, change, newQty, newStatus);
                }
                if (oldStatus !== newStatus && oldQty === newQty) {
                  await logChange(db, user, {...currentItem, ...itemForLog}, "status", 0, newQty, newStatus);
                }
              } else {
                const newDocRef = await addDoc(collectionRef, form);
                const newItem = { ...itemForLog, id: newDocRef.id };
                await logChange(db, user, newItem, "new", form.quantity, form.quantity);
              }
              closeModal();
            } catch (err) { console.error("Error saving inventory item: ", err); }
          };
          
          const handleTakeStock = async (takeAmount) => {
            if (!db || !user || !currentItem || !canManage) return;
            const newQuantity = currentItem.quantity - takeAmount;
            try {
              await logChange(db, user, currentItem, "used", -takeAmount, newQuantity, currentItem.status);
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', currentItem.id);
              await updateDoc(docRef, { quantity: newQuantity });
              closeModal();
            } catch (err) { console.error("Error taking stock: ", err); }
          };
          
          const handleDelete = async (item) => {
            if (!canManage || !window.confirm(t('inventory.deleteConfirm', {lotNumber: item.lotNumber}))) return;
            if (!db || !user) return;
            try {
              await logChange(db, user, item, "deleted", -item.quantity, 0, t('inventory.status.disposed'));
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', item.id));
            } catch (err) { console.error("Error deleting item: ", err); }
          };
          
          const handleStatusChange = async (docId, newStatus) => {
            if (!db || !user || !canManage) return;
            const item = populatedInventory.find(i => i.id === docId); 
            if (!item) return;
            try {
              await logChange(db, user, item, "status", 0, item.quantity, newStatus);
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', docId), { status: newStatus });
            } catch (err) { console.error("Error updating status: ", err); }
          };
          
          const getStatusColor = (status, expDate) => {
            const isExpired = expDate && new Date(expDate) < new Date();
            if (status === t('inventory.status.disposed')) return 'bg-gray-200 text-gray-800';
            if (status === t('inventory.status.expired') || isExpired) return 'bg-red-100 text-red-800';
            if (status === t('inventory.status.quarantined')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-green-100 text-green-800';
          };
          
          const lowStockItems = useMemo(() => {
            return populatedInventory.map(item => {
                const masterItem = item.masterItem;
                const threshold = masterItem?.lowStockThreshold || 3;
                if (item.quantity <= threshold && item.status === t('inventory.status.approved')) {
                  return { id: item.id, name: masterItem ? `${masterItem.itemId} - ${masterItem.nameAndSpec}` : 'Unknown Item',
                    quantity: item.quantity, threshold: threshold, };
                }
                return null;
              }).filter(Boolean);
          }, [populatedInventory, t]);

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('inventory.title')}</h2>
                {canManage && (
                  <Button onClick={openAddModal} variant="primary" disabled={masterItems.length === 0 || labs.length === 0}>
                    <IconPlus /> {t('inventory.addNew')}
                  </Button>
                )}
              </div>
              
              {masterItems.length === 0 && canManage && (
                 <div className="bg-yellow-100 border-s-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-start" role="alert">
                   <p>{t('inventory.noMasterItem')}</p>
                 </div>
              )}
              {labs.length === 0 && canManage && (
                 <div className="bg-yellow-100 border-s-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-start" role="alert">
                   <p>{t('inventory.noLab')}</p>
                 </div>
              )}

              {lowStockItems.length > 0 && (
                <div className="bg-yellow-50 border-s-4 border-yellow-400 p-4 mb-4 rounded-md shadow-sm text-start">
                  <div className="flex items-center gap-3">
                    <IconAlertTriangle />
                    <h3 className="text-lg font-semibold text-yellow-800">{t('inventory.lowStockWarn')}</h3>
                  </div>
                  <ul className="mt-2 list-disc list-inside text-yellow-700 space-y-1">
                    {lowStockItems.map(item => (
                      <li key={item.id}>
                        <strong>{item.name}:</strong> {t('inventory.lowStockMsg', {quantity: item.quantity, threshold: item.threshold})}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {isLoading && <p>{t('inventory.loading')}</p>}
              {error && <p className="text-red-500">{t('inventory.error')}</p>}

              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.name')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.lot')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.lab')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.expires')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.quantity')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.location')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.status')}</th>
                      {canManage && <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.actions')}</th>}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {populatedInventory.map((item) => {
                      const masterItem = item.masterItem;
                      const itemName = masterItem ? `${masterItem.itemId} - ${masterItem.nameAndSpec}` : "Loading...";
                      const statusColor = getStatusColor(item.status, item.expirationDate);
                      const lowStockThreshold = masterItem?.lowStockThreshold || 3;
                      const isLowStock = item.quantity <= lowStockThreshold && item.status === t('inventory.status.approved');
                      const canTake = item.quantity > 0 && item.status === t('inventory.status.approved') && canManage;
                      
                      return (
                        <tr key={item.id}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{itemName}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lotNumber}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">{item.labName}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm ${statusColor.includes('red') ? 'font-bold' : 'text-gray-500'}`}>{formatDate(item.expirationDate)}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm text-center ${isLowStock ? 'font-bold text-yellow-700' : 'text-gray-500'}`}>{isLowStock && <IconAlertTriangle />}{item.quantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.storageLocation}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm">
                            <Select value={item.status} onChange={(e) => handleStatusChange(item.id, e.target.value)} disabled={!canManage} className={`text-xs font-medium rounded-full p-1 border-none ${statusColor}`}>
                              {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                            </Select>
                          </td>
                          {canManage && (
                            <td className="px-6 py-4 whitespace-nowrap text-end text-sm font-medium">
                              <div className="flex justify-end gap-2">
                                <Button variant="warning" onClick={() => openTakeModal(item)} aria-label={t('inventory.take')} disabled={!canTake}>
                                  <IconMinus /> {t('inventory.take')}
                                </Button>
                                <Button variant="secondary" onClick={() => openEditModal(item)} aria-label={t('inventory.edit')}><IconEdit /></Button>
                                <Button variant="danger" onClick={() => handleDelete(item)} aria-label={t('inventory.delete')}><IconTrash /></Button>
                              </div>
                            </td>
                          )}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? t('inventory.modal.editTitle') : t('inventory.modal.addTitle')} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <Select label={t('inventory.modal.masterItem')} id="masterItemId" name="masterItemId" value={form.masterItemId} onChange={handleChange} required disabled={isEditing}>
                    <option value="" disabled>{t('inventory.modal.selectItem')}</option>
                    {masterItems.map(item => (<option key={item.id} value={item.id}>{item.itemId} - {item.nameAndSpec}</option>))}
                  </Select>
                  
                  <Select label={t('inventory.modal.lab')} id="labId" name="labId" value={form.labId} onChange={handleChange} required>
                    <option value="" disabled>{t('inventory.modal.selectLab')}</option>
                    {labs.map(lab => (<option key={lab.id} value={lab.id}>{lab.name}</option>))}
                  </Select>
                  
                  <Input label={t('inventory.modal.lot')} id="lotNumber" name="lotNumber" value={form.lotNumber} onChange={handleChange} required disabled={isEditing} />
                  <Input label={t('inventory.modal.received')} id="dateReceived" name="dateReceived" type="date" value={form.dateReceived} onChange={handleChange} required />
                  <Input label={t('inventory.modal.expires')} id="expirationDate" name="expirationDate" type="date" value={form.expirationDate} onChange={handleChange} />
                  <Input label={t('inventory.modal.quantity')} id="quantity" name="quantity" type="number" min="0" value={form.quantity} onChange={handleChange} required />
                  <Input label={t('inventory.modal.location')} id="storageLocation" name="storageLocation" value={form.storageLocation} onChange={handleChange} />
                  <Select label={t('inventory.modal.status')} id="status" name="status" value={form.status} onChange={handleChange}>
                    {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                  </Select>
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>{t('masterList.modal.cancel')}</Button>
                    <Button type="submit" variant="primary">{isEditing ? t('masterList.modal.save') : t('masterList.modal.add')}</Button>
                  </div>
                </form>
              </Modal>
              
              <TakeStockModal isOpen={isTakeModalOpen} onClose={closeModal} item={currentItem} onConfirm={handleTakeStock} />
            </div>
          );
        };

        // --- Inventory Log Component ---
        const InventoryLog = ({ logItems, isLoading, error }) => { // Receives logItems as prop
          const { t } = useLang();

          const handleExport = () => {
             const headers = ['timestamp', 'userEmail', 'itemName', 'lotNumber', 'labName', 'action', 'quantityChange', 'newQuantity', 'status'];
            exportToCSV(logItems, headers, 'inventory-log.csv', t);
          };
          
          const getActionColor = (action) => {
            if (action === translations.en.log.actions.added) return 'text-green-600';
            if (action === translations.en.log.actions.used) return 'text-yellow-700';
            if (action === translations.en.log.actions.deleted) return 'text-red-600';
            return 'text-gray-600';
          };
          
          const formatChange = (change) => {
            if (change > 0) return `+${change}`;
            if (change < 0) return `${change}`;
            return '0';
          }

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('log.title')}</h2>
                <Button onClick={handleExport} variant="secondary">
                  <IconDownload /> {t('log.export')}
                </Button>
              </div>
              
              {isLoading && <p>{t('log.loading')}</p>}
              {error && <p className="text-red-500">{error}</p>}

              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.timestamp')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.userEmail')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.itemName')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.lotNumber')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.labName')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.action')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.quantityChange')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.newQuantity')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.status')}</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {logItems.map((item) => {
                      const actionKey = Object.keys(translations.en.log.actions).find(key => translations.en.log.actions[key] === item.action);
                      const displayAction = t(`log.actions.${actionKey}`) || item.action;
                      const statusKey = Object.keys(translations.en.inventory.status).find(key => translations.en.inventory.status[key] === item.status);
                      const displayStatus = t(`inventory.status.${statusKey}`) || item.status;
                      
                      return (
                        <tr key={item.id}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(item.timestamp, true)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">{item.userEmail}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.itemName}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lotNumber}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">{item.labName}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${getActionColor(item.action)}`}>{displayAction}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${getActionColor(item.action)}`}>{formatChange(item.quantityChange)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.newQuantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{displayStatus}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };
        
        // --- Manage Accounts Component ---
        const ManageAccounts = ({ db, user, userRole }) => {
          const { t } = useLang();
          const [users, setUsers] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          
          const roles = Object.keys(t('admin.roles')); // ['admin', 'technician', 'viewer']

          useEffect(() => {
            if (!db || userRole !== 'admin') {
              setIsLoading(false);
              return;
            };
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const userList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setUsers(userList);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching users: ", err); setError(t('admin.error')); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, userRole, t]);
          
          const handleRoleChange = async (userId, newRole) => {
            if (userId === user.uid && newRole !== 'admin') {
              if (!window.confirm(t('admin.demoteWarning'))) {
                return;
              }
            }
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
              await updateDoc(userDocRef, { role: newRole });
            } catch (err) { console.error("Error updating role: ", err); }
          };

          if (userRole !== 'admin') {
            return <div className="p-4 text-red-600">{t('admin.noPermission')}</div>;
          }
          if (isLoading) return <p>{t('admin.loading')}</p>;
          if (error) return <p className="text-red-500">{error}</p>;

          return (
            <div className="p-4">
              <h2 className="text-2xl font-semibold text-gray-800 mb-4">{t('admin.title')}</h2>
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.header.email')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.header.uid')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.header.role')}</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {users.map((u) => (
                      <tr key={u.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{u.email}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{u.id}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <Select
                            id={`role-${u.id}`}
                            value={u.role}
                            onChange={(e) => handleRoleChange(u.id, e.target.value)}
                          >
                            {roles.map(r => <option key={r} value={r}>{t(`admin.roles.${r}`)}</option>)}
                          </Select>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };
        
        // --- Manage Labs Component ---
        const ManageLabs = ({ db, user, userRole }) => {
          const { t } = useLang();
          const [labs, setLabs] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [currentLab, setCurrentLab] = useState(null);
          const [labName, setLabName] = useState('');

          useEffect(() => {
            if (!db || userRole !== 'admin') {
              setIsLoading(false);
              return;
            };
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'labs');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const labList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setLabs(labList);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching labs: ", err); setError(t('labs.error')); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, userRole, t]);

          const resetForm = () => { setIsEditing(false); setCurrentLab(null); setLabName(''); };
          const closeModal = () => { setIsModalOpen(false); resetForm(); };
          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (lab) => {
            setIsEditing(true); setCurrentLab(lab); setLabName(lab.name); setIsModalOpen(true);
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !labName) return;
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'labs');
              if (isEditing) {
                await setDoc(doc(collectionRef, currentLab.id), { name: labName });
              } else {
                await addDoc(collectionRef, { name: labName });
              }
              closeModal();
            } catch (err) { console.error("Error saving lab: ", err); }
          };
          
          const handleDelete = async (lab) => {
            if (!window.confirm(t('labs.deleteConfirm', {labName: lab.name}))) return;
            try {
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'labs', lab.id));
            } catch (err) { console.error("Error deleting lab: ", err); }
          };

          if (userRole !== 'admin') {
            return <div className="p-4 text-red-600">{t('admin.noPermission')}</div>;
          }
          if (isLoading) return <p>{t('labs.loading')}</p>;
          if (error) return <p className="text-red-500">{error}</p>;

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('labs.title')}</h2>
                <Button onClick={openAddModal} variant="primary">
                  <IconPlus /> {t('labs.addNew')}
                </Button>
              </div>
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('labs.header.name')}</th>
                      <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">{t('labs.header.actions')}</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {labs.map((lab) => (
                      <tr key={lab.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{lab.name}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-end text-sm font-medium">
                          <div className="flex justify-end gap-2">
                            <Button variant="secondary" onClick={() => openEditModal(lab)} aria-label="Edit"><IconEdit /></Button>
                            <Button variant="danger" onClick={() => handleDelete(lab)} aria-label="Delete"><IconTrash /></Button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              
              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? t('labs.modal.editTitle') : t('labs.modal.addTitle')} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <Input label={t('labs.modal.name')} id="labName" name="labName" value={labName} onChange={(e) => setLabName(e.target.value)} required autoFocus />
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>{t('labs.modal.cancel')}</Button>
                    <Button type="submit" variant="primary">{isEditing ? t('labs.modal.save') : t('labs.modal.add')}</Button>
                  </div>
                </form>
              </Modal>
            </div>
          );
        };
        
        // --- NEW: Dashboard Component ---
        const Dashboard = ({ logItems, masterItems, labs, inventoryItems }) => {
          const { t, language } = useLang();
          const [selectedLab, setSelectedLab] = useState('all');
          const [selectedItem, setSelectedItem] = useState('all');
          
          const consumptionChartRef = useRef(null);
          const statusChartRef = useRef(null);

          // 1. Memoized Data for Monthly Consumption Chart
          const consumptionData = useMemo(() => {
            const actionToTrack = translations.en.log.actions.used;
            
            // Get last 12 months labels (e.g., "2025-11", "2025-10"...)
            const labels = [];
            const data = {};
            const today = new Date();
            for (let i = 0; i < 12; i++) {
              const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
              const key = d.toISOString().substring(0, 7); // "YYYY-MM"
              labels.push(key);
              data[key] = 0;
            }
            labels.reverse(); // Oldest to newest
            
            const filteredLogs = logItems.filter(item => {
              const isUsedAction = item.action === actionToTrack;
              const labMatch = selectedLab === 'all' || item.labId === selectedLab;
              const itemMatch = selectedItem === 'all' || item.masterItemId === selectedItem;
              return isUsedAction && labMatch && itemMatch;
            });
            
            filteredLogs.forEach(item => {
              if (item.timestamp && item.timestamp.toDate) {
                const key = item.timestamp.toDate().toISOString().substring(0, 7);
                if (data[key] !== undefined) {
                  data[key] += Math.abs(item.quantityChange || 0);
                }
              }
            });
            
            return {
              labels,
              datasets: [{
                label: t('dashboard.consumptionLabel'),
                data: labels.map(key => data[key]),
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
              }]
            };
          }, [logItems, selectedLab, selectedItem, t]);

          // 2. Memoized Data for Status Pie Chart
          const statusData = useMemo(() => {
            const statusCounts = {};
            const statusColors = {};
            const approvedKey = t('inventory.status.approved');
            const expiredKey = t('inventory.status.expired');
            const quarantinedKey = t('inventory.status.quarantined');
            const disposedKey = t('inventory.status.disposed');
            
            statusCounts[approvedKey] = 0;
            statusCounts[expiredKey] = 0;
            statusCounts[quarantinedKey] = 0;
            statusCounts[disposedKey] = 0;
            
            statusColors[approvedKey] = 'rgba(34, 197, 94, 0.7)'; // Green
            statusColors[expiredKey] = 'rgba(239, 68, 68, 0.7)'; // Red
            statusColors[quarantinedKey] = 'rgba(234, 179, 8, 0.7)'; // Yellow
            statusColors[disposedKey] = 'rgba(107, 114, 128, 0.7)'; // Gray
            
            inventoryItems.forEach(item => {
              const isExpired = item.expirationDate && new Date(item.expirationDate) < new Date();
              let status = item.status;
              if (isExpired && status !== disposedKey) {
                status = expiredKey;
              }
              if (statusCounts[status] !== undefined) {
                statusCounts[status] += item.quantity;
              }
            });

            return {
              labels: Object.keys(statusCounts),
              datasets: [{
                data: Object.values(statusCounts),
                backgroundColor: Object.values(statusColors)
              }]
            };
          }, [inventoryItems, t]);

          // Render Consumption Chart
          useEffect(() => {
            const ctx = document.getElementById('consumptionChart');
            if (!ctx) return;
            
            if (consumptionChartRef.current) {
              consumptionChartRef.current.destroy();
            }
            
            consumptionChartRef.current = new Chart(ctx, {
              type: 'bar',
              data: consumptionData,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: { beginAtZero: true, title: { display: true, text: t('dashboard.consumptionLabel') } },
                  x: { title: { display: true, text: language === 'fa' ? 'ماه' : 'Month' } }
                },
                plugins: {
                  legend: { display: false },
                  title: { display: true, text: t('dashboard.consumptionTitle'), font: { size: 18 } }
                }
              }
            });
            
            return () => {
              if (consumptionChartRef.current) {
                consumptionChartRef.current.destroy();
              }
            };
          }, [consumptionData, t, language]);
          
          // Render Status Chart
          useEffect(() => {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;
            
            if (statusChartRef.current) {
              statusChartRef.current.destroy();
            }
            
            statusChartRef.current = new Chart(ctx, {
              type: 'pie',
              data: statusData,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: language === 'fa' ? 'left' : 'right' },
                  title: { display: true, text: t('dashboard.statusTitle'), font: { size: 18 } }
                }
              }
            });
            
            return () => {
              if (statusChartRef.current) {
                statusChartRef.current.destroy();
              }
            };
          }, [statusData, t, language]);

          return (
            <div className="p-4 space-y-6">
              <h2 className="text-2xl font-semibold text-gray-800">{t('dashboard.title')}</h2>
              
              {/* Consumption Chart Card */}
              <div className="bg-white p-6 rounded-lg shadow-md">
                <h3 className="text-xl font-semibold text-gray-900 mb-4">{t('dashboard.consumptionTitle')}</h3>
                {/* Filters */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <Select
                    label={t('dashboard.filterLab')}
                    id="labFilter"
                    value={selectedLab}
                    onChange={(e) => setSelectedLab(e.target.value)}
                  >
                    <option value="all">{t('dashboard.allLabs')}</option>
                    {labs.map(lab => (
                      <option key={lab.id} value={lab.id}>{lab.name}</option>
                    ))}
                  </Select>
                  <Select
                    label={t('dashboard.filterItem')}
                    id="itemFilter"
                    value={selectedItem}
                    onChange={(e) => setSelectedItem(e.target.value)}
                  >
                    <option value="all">{t('dashboard.allItems')}</option>
                    {masterItems.map(item => (
                      <option key={item.id} value={item.id}>{item.itemId} - {item.nameAndSpec}</option>
                    ))}
                  </Select>
                </div>
                {/* Chart Canvas */}
                <div className="relative h-96">
                  <canvas id="consumptionChart"></canvas>
                </div>
              </div>
              
              {/* Status Chart Card */}
              <div className="bg-white p-6 rounded-lg shadow-md">
                <h3 className="text-xl font-semibold text-gray-900 mb-4 text-center">{t('dashboard.statusTitle')}</h3>
                <div className="relative h-80">
                  <canvas id="statusChart"></canvas>
                </div>
              </div>
              
            </div>
          );
        };
        
        // --- Auth Page Component ---
        const AuthPage = ({ auth, db }) => {
          const { t } = useLang();
          const [isLoginView, setIsLoginView] = useState(true);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState(null);
          const [loading, setLoading] = useState(false);

          const handleAuthError = (err) => {
            switch (err.code) {
              case 'auth/user-not-found':
              case 'auth/wrong-password': setError(t('auth.error.invalid')); break;
              case 'auth/email-already-in-use': setError(t('auth.error.inUse')); break;
              case 'auth/weak-password': setError(t('auth.error.weakPass')); break;
              default: setError(t('auth.error.unknown'));
            }
            console.error("Auth Error: ", err);
          };
          
          const createNewUserDocument = async (user) => {
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
              await setDoc(userDocRef, {
                email: user.email,
                role: 'viewer' 
              });
            } catch (err) { console.error("Error creating user role document: ", err); }
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError(null);
            try {
              if (isLoginView) {
                await signInWithEmailAndPassword(auth, email, password);
              } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await createNewUserDocument(userCredential.user);
              }
            } catch (err) {
              handleAuthError(err);
              setLoading(false);
            }
          };

          return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
              <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-lg shadow-md">
                <div><h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">{isLoginView ? t('auth.signInTitle') : t('auth.signUpTitle')}</h2></div>
                <div className="flex border-b border-gray-200">
                  <button onClick={() => setIsLoginView(true)} className={`w-1/2 py-4 px-1 text-center text-sm font-medium ${isLoginView ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>{t('auth.signIn')}</button>
                  <button onClick={() => setIsLoginView(false)} className={`w-1/2 py-4 px-1 text-center text-sm font-medium ${!isLoginView ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>{t('auth.signUp')}</button>
                </div>
                <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                  <Input label={t('auth.email')} id="email-address" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => setEmail(e.target.value)} />
                  <Input label={t('auth.password')} id="password" name="password" type="password" autoComplete="current-password" required value={password} onChange={(e) => setPassword(e.target.value)} />
                  {error && <p className="text-red-600 text-sm text-center">{error}</p>}
                  <div><Button type="submit" variant="primary" className="w-full justify-center" disabled={loading}>{loading ? t('auth.processing') : (isLoginView ? t('auth.signIn') : t('auth.createAccount'))}</Button></div>
                </form>
              </div>
            </div>
          );
        };


        // --- Main App Component ---
        function App() {
          const { t, language, setLanguage } = useLang();
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [currentUser, setCurrentUser] = useState(null);
          const [userRole, setUserRole] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false); 
          const [currentPage, setCurrentPage] = useState('dashboard'); // Default to dashboard
          const [masterItems, setMasterItems] = useState([]);
          const [masterLoading, setMasterLoading] = useState(true);
          const [masterError, setMasterError] = useState(null);
          const [labs, setLabs] = useState([]);
          const [inventoryItems, setInventoryItems] = useState([]); // New: For status chart
          const [logItems, setLogItems] = useState([]); // New: For consumption chart
          const [logLoading, setLogLoading] = useState(true);
          const [logError, setLogError] = useState(null);
          const [authError, setAuthError] = useState(null);

          // Initialize Firebase
          useEffect(() => {
            if (!window.firebase) {
              setAuthError(t('app.connectionErrorMsg')); setIsAuthReady(true); return;
            }
            try {
              const app = initializeApp(firebaseConfig);
              const authInstance = getAuth(app);
              const dbInstance = getFirestore(app);
              setAuth(authInstance);
              setDb(dbInstance);
            } catch (e) {
              console.error("Error initializing Firebase: ", e);
              setAuthError(t('app.authError')); setIsAuthReady(true); 
            }
          }, [t]);

          // Listen for Auth changes and fetch role
          useEffect(() => {
            if (!auth || !db) return; 

            const unsubscribe = onAuthStateChanged(auth, async (user) => {
              try {
                if (user) {
                  const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                  const userDoc = await getDoc(userDocRef);
                  if (userDoc.exists()) {
                    setUserRole(userDoc.data().role);
                  } else {
                    console.warn("User doc not found for " + user.uid + ". Creating.");
                    try {
                      await setDoc(userDocRef, { email: user.email, role: 'viewer' });
                      setUserRole('viewer');
                    } catch(createError) {
                       console.error("Failed to create user doc: ", createError);
                       throw createError;
                    }
                  }
                  setCurrentUser(user);
                } else {
                  setCurrentUser(null);
                  setUserRole(null);
                }
              } catch (e) {
                console.error("Critical Auth Error: ", e);
                setAuthError("A critical error occurred while fetching user permissions: " + e.message);
                setCurrentUser(null); 
                setUserRole(null);
              } finally {
                setIsAuthReady(true); 
              }
            });
            return () => unsubscribe();
          }, [auth, db]);

          // Fetch Master List
          useEffect(() => {
            if (!isAuthReady || !db || !currentUser || !userRole) {
                if (!currentUser) setMasterLoading(false); return;
            }
            setMasterLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'masterList');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMasterItems(items);
              setMasterLoading(false);
            }, (err) => {
              console.error("Error fetching master list: ", err);
              setMasterError(t('masterList.error'));
              setMasterLoading(false);
            });
            return () => unsubscribe();
          }, [db, isAuthReady, currentUser, userRole, t]);
          
          // Fetch Labs
          useEffect(() => {
            if (!isAuthReady || !db || !currentUser || !userRole) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'labs');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setLabs(items);
            }, (err) => { console.error("Error fetching labs: ", err); });
            return () => unsubscribe();
          }, [db, isAuthReady, currentUser, userRole]);
          
          // New: Fetch Inventory Log (for Dashboard)
          useEffect(() => {
            if (!isAuthReady || !db || !currentUser || !userRole) {
              if (!currentUser) setLogLoading(false); return;
            }
            setLogLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventoryLog');
            const q = query(collectionRef, orderBy('timestamp', 'desc')); 
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setLogItems(items);
              setLogLoading(false);
            }, (err) => {
              console.error("Error fetching log: ", err);
              setLogError(t('log.error'));
              setLogLoading(false);
            });
            return () => unsubscribe();
          }, [db, isAuthReady, currentUser, userRole, t]);
          
          // New: Fetch Active Inventory (for Dashboard)
          useEffect(() => {
            if (!isAuthReady || !db || !currentUser || !userRole) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setInventoryItems(items);
            }, (err) => { console.error("Error fetching inventory: ", err); });
            return () => unsubscribe();
          }, [db, isAuthReady, currentUser, userRole]);
          
          
          const handleSignOut = async () => {
            if (auth) {
              try { await signOut(auth); } catch (err) { console.error("Error signing out: ", err); }
            }
          };

          const NavButton = ({ page, label, icon }) => (
            <button
              onClick={() => setCurrentPage(page)}
              className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium ${
                currentPage === page ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'
              }`}
            >
              {icon}
              {label}
            </button>
          );
          
          const LanguageSwitcher = () => {
            return (
              <div className="flex items-center gap-1 bg-gray-200 rounded-full p-1">
                <button 
                  onClick={() => setLanguage('en')}
                  className={`px-3 py-1 rounded-full text-sm font-medium ${language === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-700'}`}
                >
                  English
                </button>
                <button 
                  onClick={() => setLanguage('fa')}
                  className={`px-3 py-1 rounded-full text-sm font-medium ${language === 'fa' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-700'}`}
                >
                  فارسی
                </button>
              </div>
            );
          };
          
          const masterItemMap = useMemo(() => {
            return masterItems.reduce((acc, item) => {
              acc[item.id] = item;
              return acc;
            }, {});
          }, [masterItems]);
          
          const labMap = useMemo(() => {
            return labs.reduce((acc, lab) => {
              acc[lab.id] = lab;
              return acc;
            }, {});
          }, [labs]);
          
          // --- Main Render Logic ---
          if (!isAuthReady) {
             return <div id="loading">{t('app.loading')}</div>
          }
          
          if (authError) {
             return (
                <div className="bg-red-100 border-s-4 border-red-500 text-red-700 p-4 m-4 text-start" role="alert">
                  <p className="font-bold">{t('app.connectionError')}</p><p>{authError}</p>
                </div>
              );
          }

          if (!currentUser) {
             return <AuthPage auth={auth} db={db} />
          }
          
          if (!userRole) {
             return <div id="loading">{t('app.loadingPermissions')}</div>
          }

          const PageContent = () => {
            switch(currentPage) {
              case 'dashboard':
                return <Dashboard 
                          logItems={logItems} 
                          inventoryItems={inventoryItems}
                          masterItems={masterItems} 
                          labs={labs} 
                        />;
              case 'inventory':
                return <ActiveInventory db={db} user={currentUser} userRole={userRole} masterItems={masterItems} labs={labs} labMap={labMap} />;
              case 'master':
                return <MasterList db={db} user={currentUser} userRole={userRole} masterItems={masterItems} isLoading={masterLoading} error={masterError} />;
              case 'log':
                return <InventoryLog logItems={logItems} isLoading={logLoading} error={logError} />;
              case 'admin':
                return <ManageAccounts db={db} user={currentUser} userRole={userRole} />;
              case 'labs':
                return <ManageLabs db={db} user={currentUser} userRole={userRole} />;
              default:
                return <Dashboard 
                          logItems={logItems} 
                          inventoryItems={inventoryItems}
                          masterItems={masterItems} 
                          labs={labs} 
                        />;
            }
          };

          return (
            <div className="min-h-screen font-sans">
              <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center h-16">
                    <div className="flex items-center gap-3">
                      <IconClipboard />
                      <h1 className="text-xl font-semibold text-gray-900">{t('app.title')}</h1>
                    </div>
                    <nav className="hidden md:flex space-x-2">
                      <NavButton page="dashboard" label={t('nav.dashboard')} icon={<IconDashboard />} />
                      <NavButton page="inventory" label={t('nav.inventory')} icon={<IconClipboard />} />
                      <NavButton page="master" label={t('nav.masterList')} icon={<IconEdit />} />
                      <NavButton page="log" label={t('nav.log')} icon={<IconHistory />} />
                      {userRole === 'admin' && (
                        <>
                          <NavButton page="labs" label={t('nav.labs')} icon={<IconLab />} />
                          <NavButton page="admin" label={t('nav.admin')} icon={<IconAdmin />} />
                        </>
                      )}
                    </nav>
                    <div className="flex items-center gap-4">
                      <LanguageSwitcher />
                      <div className="hidden sm:block text-sm font-medium text-gray-600">
                        {t('app.user')}: <span className="font-bold text-blue-600">{currentUser.email}</span> (<span className="italic">{t(`admin.roles.${userRole}`)}</span>)
                      </div>
                      <Button onClick={handleSignOut} variant="secondary" className="px-3 py-1.5">
                        <IconSignOut /> <span className="hidden sm:inline">{t('app.signOut')}</span>
                      </Button>
                    </div>
                  </div>
                  {/* Mobile Nav */}
                  <nav className="flex md:hidden space-x-2 pb-2 justify-center flex-wrap">
                      <NavButton page="dashboard" label={t('nav.dashboard')} icon={<IconDashboard />} />
                      <NavButton page="inventory" label={t('nav.inventory')} icon={<IconClipboard />} />
                      <NavButton page="master" label={t('nav.masterList')} icon={<IconEdit />} />
                      <NavButton page="log" label={t('nav.log')} icon={<IconHistory />} />
                      {userRole === 'admin' && (
                        <>
                          <NavButton page="labs" label={t('nav.labs')} icon={<IconLab />} />
                          <NavButton page="admin" label={t('nav.admin')} icon={<IconAdmin />} />
                        </>
                      )}
                    </nav>
                </div>
              </header>
              <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <PageContent />
              </main>
            </div>
          );
        }

        // 6. Render the App, wrapped in the Language Provider
        const checkFirebase = setInterval(() => {
          if (window.firebase && window.Chart) { // Wait for both Firebase and Chart.js
            clearInterval(checkFirebase);
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
              <LangProvider>
                <App />
              </LangProvider>
            );
          }
        }, 100);

    </script>
</body>
</html>

