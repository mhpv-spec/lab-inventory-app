<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Inventory Manager (cons-593c6)</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 3. Load Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. Load Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
        getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
        signInWithEmailAndPassword, signOut
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
        onSnapshot, collection, query, setLogLevel, serverTimestamp, orderBy, getDoc
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.firebase = {
        app: { initializeApp },
        auth: { 
          getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
          signInWithEmailAndPassword, signOut
        },
        firestore: {
          getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
          collection, query, setLogLevel, serverTimestamp, orderBy, getDoc
        }
      };
    </script>
    
    <!-- 5. Load Google Fonts (Inter for EN, Vazirmatn for FA) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      /* Apply Vazirmatn font when in Farsi */
      [lang="fa"] body {
        font-family: 'Vazirmatn', sans-serif;
      }
      /* Default font */
      body { 
        font-family: 'Inter', sans-serif; 
      }
      #loading {
        display: flex; justify-content: center; align-items: center;
        height: 100vh; font-size: 1.2rem; font-weight: 500; color: #333;
      }
      button:disabled, select:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      /* Tailwind logical properties for RTL support */
      .text-start { text-align: left; }
      .text-end { text-align: right; }
      [dir="rtl"] .text-start { text-align: right; }
      [dir="rtl"] .text-end { text-align: left; }
      
      .ms-2 { margin-left: 0.5rem; }
      .me-2 { margin-right: 0.5rem; }
      [dir="rtl"] .ms-2 { margin-left: 0; margin-right: 0.5rem; }
      [dir="rtl"] .me-2 { margin-right: 0; margin-left: 0.5rem; }

      .gap-2 { gap: 0.5rem; }
      .gap-3 { gap: 0.75rem; }
      .gap-4 { gap: 1rem; }
      
      .ps-4 { padding-left: 1rem; }
      .pe-4 { padding-right: 1rem; }
      [dir="rtl"] .ps-4 { padding-left: 0; padding-right: 1rem; }
      [dir="rtl"] .pe-4 { padding-right: 0; padding-left: 1rem; }
    </style>
</head>
<body class="bg-gray-100">
    
    <div id="root">
        <div id="loading">Connecting to your lab inventory...</div>
    </div>

    <!-- 5. React App Code (transpiled by Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyACGODYoAc5Yc7dzX8aYlX8t-UhPUyy9oM",
          authDomain: "cons-593c6.firebaseapp.com",
          projectId: "cons-593c6",
          storageBucket: "cons-593c6.firebasestorage.app",
          messagingSenderId: "674188672813",
          appId: "1:674188672813:web:887caed5ea2fc927fbdda4",
          measurementId: "G-TK88H80GYC"
        };
        const appId = "cons-593c6"; 
        
        // --- Destructure Firebase from window ---
        const { initializeApp } = window.firebase.app;
        const { 
          getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
          signInWithEmailAndPassword, signOut
        } = window.firebase.auth;
        const { 
          getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, 
          onSnapshot, collection, query, setLogLevel, serverTimestamp, orderBy, getDoc
        } = window.firebase.firestore;

        // --- 1. TRANSLATION DICTIONARY ---
        const translations = {
          en: {
            app: {
              title: "Shared Lab Manager (Cloud)",
              loading: "Connecting to your lab inventory...",
              loadingPermissions: "Loading user permissions...",
              user: "User",
              signOut: "Sign Out",
              connectionError: "Connection Error",
              connectionErrorMsg: "Failed to load Firebase SDKs. Please check your network connection and refresh.",
              authError: "Failed to initialize database. Check Firebase config.",
              authFailed: "Authentication failed. Cannot connect to database.",
            },
            nav: {
              inventory: "Active Inventory",
              masterList: "Master List",
              log: "Inventory Log",
              admin: "Manage Accounts"
            },
            auth: {
              signInTitle: "Sign in to your account",
              signUpTitle: "Create a new account",
              signIn: "Sign In",
              signUp: "Sign Up",
              email: "Email address",
              password: "Password",
              processing: "Processing...",
              createAccount: "Create Account",
              error: {
                invalid: "Invalid email or password.",
                inUse: "This email address is already in use.",
                weakPass: "Password is too weak. Must be at least 6 characters.",
                unknown: "An unknown error occurred. Please try again."
              }
            },
            masterList: {
              title: "Master Consumable List",
              export: "Export to CSV",
              addNew: "Add New Master Item",
              loading: "Loading master list...",
              error: "Failed to load master list.",
              header: {
                id: "Item ID",
                category: "Category",
                name: "Name & Specification",
                suppliers: "Approved Suppliers",
                actions: "Actions"
              },
              deleteConfirm: "Are you sure you want to delete this master item?",
              modal: {
                editTitle: "Edit Master Item",
                addTitle: "Add New Master Item",
                id: "Item ID (e.g., SP-001)",
                category: "Category",
                name: "Name & Specification",
                suppliers: "Approved Suppliers",
                verification: "Acceptance / Verification Action",
                lowStock: "Low Stock Threshold",
                cancel: "Cancel",
                save: "Save Changes",
                add: "Add Item"
              },
              categories: ['Sample Prep', 'Chemical Analysis', 'General Lab']
            },
            inventory: {
              title: "Active Inventory",
              addNew: "Add New Stock",
              noMasterItem: "Please add at least one item to the **Master Consumable List** before adding stock to the inventory.",
              lowStockWarn: "Low Stock Warning",
              lowStockMsg: "Currently {quantity} in stock (threshold is {threshold}).",
              loading: "Loading inventory...",
              error: "Failed to load inventory.",
              header: {
                name: "Item Name",
                lot: "Lot #",
                expires: "Expires",
                quantity: "Quantity",
                location: "Location",
                status: "Status",
                actions: "Actions"
              },
              status: {
                approved: "Approved for Use",
                quarantined: "Quarantined",
                disposed: "Disposed",
                expired: "Expired"
              },
              take: "Take",
              edit: "Edit",
              delete: "Delete",
              deleteConfirm: "Are you sure you want to delete Lot {lotNumber}? This action will be logged.",
              modal: {
                editTitle: "Edit Inventory Item",
                addTitle: "Add New Stock Item",
                masterItem: "Master Item",
                selectItem: "Select an approved item",
                lot: "Lot / Batch Number",
                received: "Date Received",
                expires: "Expiration Date",
                quantity: "Quantity",
                location: "Storage Location",
                status: "Status",
                cancel: "Cancel",
                save: "Save Changes",
                add: "Add Item"
              },
              takeModal: {
                title: "Take Stock",
                inStock: "Currently in Stock:",
                quantity: "Quantity to Take:",
                errorZero: "Amount must be greater than zero.",
                errorMore: "Amount cannot be more than the {quantity} in stock.",
                confirm: "Confirm & Log"
              }
            },
            log: {
              title: "Inventory Log",
              export: "Export to CSV",
              loading: "Loading log...",
              error: "Failed to load inventory log.",
              header: {
                timestamp: "Timestamp",
                user: "User",
                name: "Item Name",
                lot: "Lot #",
                action: "Action",
                change: "Change",
                newQty: "New Qty",
                status: "Status"
              },
              actions: {
                added: "Stock Added",
                used: "Stock Used",
                correction: "Stock Used/Correction",
                status: "Status Change",
                new: "New Item Added",
                deleted: "Item Deleted"
              }
            },
            admin: {
              title: "Manage User Accounts",
              noPermission: "You do not have permission to view this page.",
              loading: "Loading user accounts...",
              error: "Failed to load user list.",
              header: {
                email: "User Email",
                uid: "User ID (UID)",
                role: "Role"
              },
              demoteWarning: "Warning: You are about to remove your own admin status. Are you sure?",
              roles: {
                admin: "Admin",
                technician: "Technician",
                viewer: "Viewer"
              }
            }
          },
          fa: {
            app: {
              title: "مدیر آزمایشگاه (ابری)",
              loading: "در حال اتصال به انبار آزمایشگاه...",
              loadingPermissions: "در حال بارگذاری دسترسی‌های کاربر...",
              user: "کاربر",
              signOut: "خروج",
              connectionError: "خطای اتصال",
              connectionErrorMsg: "بارگذاری Firebase SDK با مشکل مواجه شد. لطفاً اتصال اینترنت خود را بررسی کرده و صفحه را رفرش کنید.",
              authError: "مقداردهی اولیه پایگاه داده ناموفق بود. تنظیمات Firebase را بررسی کنید.",
              authFailed: "احراز هویت ناموفق بود. امکان اتصال به پایگاه داده وجود ندارد.",
            },
            nav: {
              inventory: "موجودی فعال",
              masterList: "لیست اصلی",
              log: "گزارش انبار",
              admin: "مدیریت حساب‌ها"
            },
            auth: {
              signInTitle: "ورود به حساب کاربری",
              signUpTitle: "ایجاد حساب کاربری جدید",
              signIn: "ورود",
              signUp: "ثبت نام",
              email: "آدرس ایمیل",
              password: "رمز عبور",
              processing: "در حال پردازش...",
              createAccount: "ایجاد حساب",
              error: {
                invalid: "ایمیل یا رمز عبور نامعتبر است.",
                inUse: "این آدرس ایمیل قبلاً استفاده شده است.",
                weakPass: "رمز عبور ضعیف است. باید حداقل ۶ کاراکتر باشد.",
                unknown: "خطایی ناشناخته رخ داد. لطفاً دوباره تلاش کنید."
              }
            },
            masterList: {
              title: "لیست اصلی مواد مصرفی",
              export: "خروجی CSV",
              addNew: "افزودن آیتم اصلی جدید",
              loading: "در حال بارگذاری لیست اصلی...",
              error: "بارگذاری لیست اصلی ناموفق بود.",
              header: {
                id: "کد کالا",
                category: "دسته‌بندی",
                name: "نام و مشخصات",
                suppliers: "تامین‌کنندگان تایید شده",
                actions: "عملیات"
              },
              deleteConfirm: "آیا از حذف این آیتم اصلی مطمئن هستید؟",
              modal: {
                editTitle: "ویرایش آیتم اصلی",
                addTitle: "افزودن آیتم اصلی جدید",
                id: "کد کالا (مثال: SP-001)",
                category: "دسته‌بندی",
                name: "نام و مشخصات",
                suppliers: "تامین‌کنندگان تایید شده",
                verification: "اقدام پذیرش / تایید",
                lowStock: "آستانه کمبود موجودی",
                cancel: "لغو",
                save: "ذخیره تغییرات",
                add: "افزودن آیتم"
              },
              categories: ['آماده‌سازی نمونه', 'آنالیز شیمیایی', 'عمومی آزمایشگاه']
            },
            inventory: {
              title: "موجودی فعال",
              addNew: "افزودن موجودی جدید",
              noMasterItem: "لطفاً قبل از افزودن موجودی، حداقل یک آیتم به **لیست اصلی مواد مصرفی** اضافه کنید.",
              lowStockWarn: "هشدار کمبود موجودی",
              lowStockMsg: "در حال حاضر {quantity} عدد موجود است (آستانه {threshold} است).",
              loading: "در حال بارگذاری موجودی...",
              error: "بارگذاری موجودی ناموفق بود.",
              header: {
                name: "نام کالا",
                lot: "شماره لات",
                expires: "انقضا",
                quantity: "تعداد",
                location: "محل نگهداری",
                status: "وضعیت",
                actions: "عملیات"
              },
              status: {
                approved: "آماده استفاده",
                quarantined: "قرنطینه",
                disposed: "اسقاط شده",
                expired: "منقضی شده"
              },
              take: "برداشت",
              edit: "ویرایش",
              delete: "حذف",
              deleteConfirm: "آیا از حذف لات {lotNumber} مطمئن هستید؟ این عملیات ثبت خواهد شد.",
              modal: {
                editTitle: "ویرایش آیتم موجودی",
                addTitle: "افزودن موجودی جدید",
                masterItem: "آیتم اصلی",
                selectItem: "یک آیتم تایید شده را انتخاب کنید",
                lot: "شماره لات / بچ",
                received: "تاریخ دریافت",
                expires: "تاریخ انقضا",
                quantity: "تعداد",
                location: "محل نگهداری",
                status: "وضعیت",
                cancel: "لغو",
                save: "ذخیره تغییرات",
                add: "افزودن آیتم"
              },
              takeModal: {
                title: "برداشت از موجودی",
                inStock: "موجودی فعلی:",
                quantity: "تعداد برداشتی:",
                errorZero: "تعداد باید بیشتر از صفر باشد.",
                errorMore: "تعداد برداشتی نمی‌تواند از {quantity} موجود بیشتر باشد.",
                confirm: "تایید و ثبت"
              }
            },
            log: {
              title: "گزارش انبار",
              export: "خروجی CSV",
              loading: "در حال بارگذاری گزارش...",
              error: "بارگذاری گزارش ناموفق بود.",
              header: {
                timestamp: "زمان",
                user: "کاربر",
                name: "نام کالا",
                lot: "شماره لات",
                action: "عملیات",
                change: "تغییر",
                newQty: "موجودی جدید",
                status: "وضعیت"
              },
              actions: {
                added: "افزایش موجودی",
                used: "برداشت موجودی",
                correction: "برداشت/اصلاح موجودی",
                status: "تغییر وضعیت",
                new: "افزودن آیتم جدید",
                deleted: "حذف آیتم"
              }
            },
            admin: {
              title: "مدیریت حساب‌های کاربری",
              noPermission: "شما اجازه دسترسی به این صفحه را ندارید.",
              loading: "در حال بارگذاری حساب‌های کاربری...",
              error: "بارگذاری لیست کاربران ناموفق بود.",
              header: {
                email: "ایمیل کاربر",
                uid: "شناسه کاربری (UID)",
                role: "نقش"
              },
              demoteWarning: "هشدار: شما در حال حذف دسترسی ادمین خود هستید. آیا مطمئن هستید؟",
              roles: {
                admin: "ادمین",
                technician: "تکنسین",
                viewer: "ناظر"
              }
            }
          }
        };

        // --- 2. LANGUAGE CONTEXT & PROVIDER ---
        const LangContext = createContext();

        const LangProvider = ({ children }) => {
          const [language, setLanguage] = useState('en'); // Default to English

          useEffect(() => {
            // Set direction for RTL support
            document.documentElement.dir = language === 'fa' ? 'rtl' : 'ltr';
            document.documentElement.lang = language;
          }, [language]);

          const t = useCallback((key, params = {}) => {
            const keys = key.split('.');
            let result = translations[language];
            try {
              for (const k of keys) {
                result = result[k];
              }
              if (typeof result === 'string') {
                // Handle simple replacements like {quantity}
                return result.replace(/\{(\w+)\}/g, (_, paramName) => params[paramName] || '');
              }
              // Handle nested keys that return an object (e.g., status)
              return result;
            } catch (e) {
              // Fallback to English if Farsi key is missing
              try {
                let fallback = translations['en'];
                for (const k of keys) {
                  fallback = fallback[k];
                }
                if (typeof fallback === 'string') {
                  return fallback.replace(/\{(\w+)\}/g, (_, paramName) => params[paramName] || '');
                }
                return fallback || key; // Return the key as last resort
              } catch (e2) {
                 return key; // Return the key itself
              }
            }
          }, [language]);

          return (
            <LangContext.Provider value={{ language, setLanguage, t }}>
              {children}
            </LangContext.Provider>
          );
        };
        
        // Custom hook to use translations
        const useLang = () => useContext(LangContext);
        

        // --- Helper Functions & Constants ---
        const formatDate = (dateInput, includeTime = false) => {
          if (!dateInput) return 'N/A';
          let date;
          if (dateInput && dateInput.toDate) { date = dateInput.toDate(); } 
          else if (typeof dateInput === 'string') { date = new Date(dateInput); } 
          else { date = dateInput; }
          
          if (!date || isNaN(date.getTime())) return 'N/A';
          
          // Use 'fa-IR' locale for Farsi dates
          const locale = document.documentElement.lang === 'fa' ? 'fa-IR' : 'en-US';
          
          const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', calendar: locale === 'fa-IR' ? 'persian' : 'gregory' };
          const timeOptions = { hour: '2-digit', minute: '2-digit' };
          
          let formattedDate;
          if (includeTime) {
            formattedDate = date.toLocaleString(locale, {...dateOptions, ...timeOptions});
          } else {
            formattedDate = date.toLocaleDateString(locale, dateOptions);
          }
          return formattedDate.replace(',', ''); 
        };
        
        const sanitizeForCSV = (value) => {
          if (value == null) return '';
          let strValue = String(value);
          if (strValue.search(/("|,|\n)/g) >= 0) {
            strValue = strValue.replace(/"/g, '""');
            return `"${strValue}"`;
          }
          return strValue;
        };

        const exportToCSV = (data, headers, filename, t) => {
          const csvRows = [];
          // Translate headers for CSV
          const translatedHeaders = headers.map(h => t(`log.header.${h}`) || t(`masterList.header.${h}`) || h);
          csvRows.push(translatedHeaders.map(sanitizeForCSV).join(','));

          for (const item of data) {
            const values = headers.map(headerKey => {
              if (headerKey === 'itemName' && item.masterItem) {
                 return sanitizeForCSV(`${item.masterItem.itemId} - ${item.masterItem.nameAndSpec}`);
              }
              if (headerKey === 'timestamp' && item.timestamp) {
                 return sanitizeForCSV(formatDate(item.timestamp, true));
              }
              if (headerKey === 'userEmail' && item.userEmail) {
                return sanitizeForCSV(item.userEmail);
              }
               // Translate status and action fields
              if (headerKey === 'status') {
                const statusKey = Object.keys(translations.en.inventory.status).find(key => translations.en.inventory.status[key] === item.status);
                return sanitizeForCSV(t(`inventory.status.${statusKey}`) || item.status);
              }
              if (headerKey === 'action') {
                 const actionKey = Object.keys(translations.en.log.actions).find(key => translations.en.log.actions[key] === item.action);
                return sanitizeForCSV(t(`log.actions.${actionKey}`) || item.action);
              }
              return sanitizeForCSV(item[headerKey]);
            });
            csvRows.push(values.join(','));
          }

          const csvString = csvRows.join('\n');
          // Add BOM for Excel to recognize UTF-8 (especially for Farsi)
          const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
          const blob = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });
          
          const link = document.createElement('a');
          if (link.download !== undefined) { 
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        };


        // --- Inline SVG Icons ---
        const IconPlus = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const IconTrash = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
        const IconEdit = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>);
        const IconClipboard = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>);
        const IconHistory = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>);
        const IconDownload = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>);
        const IconMinus = () => (<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const IconSignOut = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>);
        const IconX = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const IconAlertTriangle = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-500 inline-block me-1"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        const IconAdmin = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>);
        const IconGlobe = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>);


        // --- Reusable UI Components ---
        const Modal = ({ isOpen, onClose, title, children, allowClose = true }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" aria-modal="true" role="dialog">
              <div className="relative w-full max-w-2xl bg-white rounded-lg shadow-xl m-4">
                <div className="flex items-center justify-between p-4 border-b rounded-t">
                  <h3 className="text-xl font-semibold text-gray-900">{title}</h3>
                  {allowClose && (
                    <button type="button" className="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ms-auto inline-flex items-center" onClick={onClose} aria-label="Close modal">
                      <IconX />
                    </button>
                  )}
                </div>
                <div className="p-6 space-y-6">{children}</div>
              </div>
            </div>
          );
        };
        
        const TakeStockModal = ({ isOpen, onClose, item, onConfirm }) => {
          const { t } = useLang();
          const [takeAmount, setTakeAmount] = useState(1);
          const [error, setError] = useState('');
          const masterItem = item?.masterItem || {};
          const currentQty = item?.quantity || 0;

          const handleSubmit = (e) => {
            e.preventDefault();
            const amount = Number(takeAmount);
            if (amount <= 0) { setError(t('inventory.takeModal.errorZero')); return; }
            if (amount > currentQty) { setError(t('inventory.takeModal.errorMore', {quantity: currentQty})); return; }
            onConfirm(amount);
          };
          
          useEffect(() => { if (isOpen) { setTakeAmount(1); setError(''); } }, [isOpen]);

          return (
            <Modal isOpen={isOpen} onClose={onClose} title={t('inventory.takeModal.title')} allowClose={true}>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <h4 className="font-medium text-gray-800">{masterItem.itemId} - {masterItem.nameAndSpec}</h4>
                  <p className="text-sm text-gray-600">{t('inventory.header.lot')}: {item?.lotNumber}</p>
                  <p className="text-sm text-gray-600">{t('inventory.takeModal.inStock')} <span className="font-bold">{currentQty}</span></p>
                </div>
                <Input label={t('inventory.takeModal.quantity')} id="takeAmount" name="takeAmount" type="number" min="1" max={currentQty} value={takeAmount} onChange={(e) => setTakeAmount(e.target.value)} required autoFocus />
                {error && <p className="text-red-600 text-sm">{error}</p>}
                <div className="flex justify-end gap-3 pt-4 border-t">
                  <Button type="button" variant="secondary" onClick={onClose}>{t('masterList.modal.cancel')}</Button>
                  <Button type="submit" variant="primary">{t('inventory.takeModal.confirm')}</Button>
                </div>
              </form>
            </Modal>
          );
        };

        const Input = ({ label, id, ...props }) => (
          <div>
            <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900 text-start">{label}</label>
            <input id={id} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed" {...props} />
          </div>
        );

        const Select = ({ label, id, children, ...props }) => (
          <div>
            <label htmlFor={id} className="block mb-2 text-sm font-medium text-gray-900 text-start">{label}</label>
            <select id={id} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 disabled:opacity-50 disabled:cursor-not-allowed" {...props}>
              {children}
            </select>
          </div>
        );

        const Button = ({ children, onClick, variant = 'primary', type = 'button', ...props }) => {
          const baseStyle = "px-4 py-2 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed";
          const variants = {
            primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
            danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
            secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
            warning: 'bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400'
          };
          return (
            <button type={type} onClick={onClick} className={`${baseStyle} ${variants[variant]}`} {...props}>
              {children}
            </button>
          );
        };

        // --- Log Helper Function ---
        const logChange = async (db, user, item, actionKey, quantityChange, newQuantity, newStatus = null) => {
          if (!db || !appId || !user || !user.uid || !user.email) {
            console.error("Log failed: DB, AppID, or User missing.");
            return;
          }
          const logCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventoryLog');
          const masterItem = item.masterItem || { itemId: 'N/A', nameAndSpec: 'N/A' };
          
          // Use the English key as the persistent log action
          const action = translations['en'].log.actions[actionKey] || actionKey;
          
          const logEntry = {
            timestamp: serverTimestamp(),
            userId: user.uid, 
            userEmail: user.email,
            inventoryItemId: item.id || 'N/A',
            masterItemId: item.masterItemId,
            itemName: `${masterItem.itemId} - ${masterItem.nameAndSpec}`,
            lotNumber: item.lotNumber,
            action: action, // Store the English action
            quantityChange: quantityChange,
            newQuantity: newQuantity,
            status: newStatus || item.status,
          };
          try { await addDoc(logCollectionRef, logEntry); } 
          catch (err) { console.error("Error writing to log: ", err); }
        };

        // --- Master List Component ---
        const MasterList = ({ db, user, userRole, masterItems, isLoading, error }) => {
          const { t } = useLang();
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [currentItemId, setCurrentItemId] = useState(null);
          const [form, setForm] = useState({
            itemId: '', category: 'Sample Prep', nameAndSpec: '',
            approvedSuppliers: '', verificationAction: '', lowStockThreshold: 3,
          });

          const categories = t('masterList.categories');
          const canManage = userRole === 'admin';

          const resetForm = () => {
            setForm({
              itemId: '', category: categories[0], nameAndSpec: '',
              approvedSuppliers: '', verificationAction: '', lowStockThreshold: 3,
            });
            setIsEditing(false);
            setCurrentItemId(null);
          };

          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (item) => {
            setForm({
              itemId: item.itemId, category: item.category, nameAndSpec: item.nameAndSpec,
              approvedSuppliers: item.approvedSuppliers, verificationAction: item.verificationAction,
              lowStockThreshold: item.lowStockThreshold || 3,
            });
            setIsEditing(true);
            setCurrentItemId(item.id);
            setIsModalOpen(true);
          };
          const closeModal = () => { setIsModalOpen(false); resetForm(); };
          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setForm((prev) => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !canManage) return;
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'masterList');
              if (isEditing) { await setDoc(doc(collectionRef, currentItemId), form); } 
              else { await addDoc(collectionRef, form); }
              closeModal();
            } catch (err) { console.error("Error saving master item: ", err); }
          };

          const handleDelete = async (docId) => {
            if (!canManage || !window.confirm(t('masterList.deleteConfirm'))) return;
            if (!db) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'masterList', docId)); } 
            catch (err) { console.error("Error deleting item: ", err); }
          };
          
          const handleExport = () => {
            const headers = ['itemId', 'category', 'nameAndSpec', 'approvedSuppliers', 'verificationAction', 'lowStockThreshold'];
            exportToCSV(masterItems, headers, 'master-consumable-list.csv', t);
          };

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('masterList.title')}</h2>
                <div className="flex gap-2">
                  <Button onClick={handleExport} variant="secondary">
                    <IconDownload /> {t('masterList.export')}
                  </Button>
                  {canManage && (
                    <Button onClick={openAddModal} variant="primary">
                      <IconPlus /> {t('masterList.addNew')}
                    </Button>
                  )}
                </div>
              </div>

              {isLoading && <p>{t('masterList.loading')}</p>}
              {error && <p className="text-red-500">{t('masterList.error')}</p>}
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.id')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.category')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.name')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.suppliers')}</th>
                      {canManage && <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">{t('masterList.header.actions')}</th>}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {masterItems.map((item) => (
                      <tr key={item.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.itemId}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{t('masterList.categories').includes(item.category) ? item.category : t('masterList.categories')[0]}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.nameAndSpec}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.approvedSuppliers}</td>
                        {canManage && (
                          <td className="px-6 py-4 whitespace-nowrap text-end text-sm font-medium">
                            <div className="flex justify-end gap-2">
                              <Button variant="secondary" onClick={() => openEditModal(item)} aria-label="Edit"><IconEdit /></Button>
                              <Button variant="danger" onClick={() => handleDelete(item.id)} aria-label="Delete"><IconTrash /></Button>
                            </div>
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? t('masterList.modal.editTitle') : t('masterList.modal.addTitle')} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <Input label={t('masterList.modal.id')} id="itemId" name="itemId" value={form.itemId} onChange={handleChange} required />
                  <Select label={t('masterList.modal.category')} id="category" name="category" value={form.category} onChange={handleChange}>
                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </Select>
                  <Input label={t('masterList.modal.name')} id="nameAndSpec" name="nameAndSpec" value={form.nameAndSpec} onChange={handleChange} required />
                  <Input label={t('masterList.modal.suppliers')} id="approvedSuppliers" name="approvedSuppliers" value={form.approvedSuppliers} onChange={handleChange} />
                  <Input label={t('masterList.modal.verification')} id="verificationAction" name="verificationAction" value={form.verificationAction} onChange={handleChange} />
                  <Input label={t('masterList.modal.lowStock')} id="lowStockThreshold" name="lowStockThreshold" type="number" min="0" value={form.lowStockThreshold} onChange={handleChange} />
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>{t('masterList.modal.cancel')}</Button>
                    <Button type="submit" variant="primary">{isEditing ? t('masterList.modal.save') : t('masterList.modal.add')}</Button>
                  </div>
                </form>
              </Modal>
            </div>
          );
        };

        // --- Active Inventory Component ---
        const ActiveInventory = ({ db, user, userRole, masterItems }) => {
          const { t } = useLang();
          const [inventoryItems, setInventoryItems] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [isTakeModalOpen, setIsTakeModalOpen] = useState(false);
          const [currentItem, setCurrentItem] = useState(null); 
          const [form, setForm] = useState({
            masterItemId: '', lotNumber: '', dateReceived: '', expirationDate: '',
            quantity: 1, storageLocation: '', status: 'Approved for Use',
          });
          
          const statuses = Object.keys(t('inventory.status')).map(key => t(`inventory.status.${key}`));
          const canManage = ['admin', 'technician'].includes(userRole);

          const masterItemMap = useMemo(() => {
            return masterItems.reduce((acc, item) => {
              acc[item.id] = item;
              return acc;
            }, {});
          }, [masterItems]);

          useEffect(() => {
            if (!db) return;
            setIsLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => {
                const data = doc.data();
                return { id: doc.id, ...data, masterItem: masterItemMap[data.masterItemId] || { itemId: 'N/A', nameAndSpec: 'N/A' } }
              });
              setInventoryItems(items);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching inventory: ", err); setError(t('inventory.error')); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, user.uid, masterItemMap]);

          const resetForm = () => {
            setForm({
              masterItemId: masterItems.length > 0 ? masterItems[0].id : '', lotNumber: '', dateReceived: '',
              expirationDate: '', quantity: 1, storageLocation: '', status: t('inventory.status.approved'),
            });
            setIsEditing(false);
            setCurrentItem(null);
          };

          const openAddModal = () => { resetForm(); setIsModalOpen(true); };
          const openEditModal = (item) => {
            setForm({
              masterItemId: item.masterItemId, lotNumber: item.lotNumber, dateReceived: item.dateReceived,
              expirationDate: item.expirationDate, quantity: item.quantity,
              storageLocation: item.storageLocation, status: item.status,
            });
            setIsEditing(true);
            setCurrentItem(item); 
            setIsModalOpen(true);
          };
          const openTakeModal = (item) => { setCurrentItem(item); setIsTakeModalOpen(true); };
          const closeModal = () => { setIsModalOpen(false); setIsTakeModalOpen(false); resetForm(); };

          const handleChange = (e) => {
            const { name, value, type } = e.target;
            setForm((prev) => ({ ...prev, [name]: type === 'number' ? Number(value) : value, }));
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!db || !user || !canManage) return;
            try {
              const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'activeInventory');
              if (isEditing) {
                const docRef = doc(collectionRef, currentItem.id);
                await setDoc(docRef, form);
                const oldQty = currentItem.quantity; const newQty = form.quantity;
                const oldStatus = currentItem.status; const newStatus = form.status;
                if (oldQty !== newQty) {
                  const change = newQty - oldQty;
                  const actionKey = change > 0 ? "added" : "correction";
                  await logChange(db, user, currentItem, actionKey, change, newQty, newStatus);
                }
                if (oldStatus !== newStatus && oldQty === newQty) {
                  await logChange(db, user, currentItem, "status", 0, newQty, newStatus);
                }
              } else {
                const newDocRef = await addDoc(collectionRef, form);
                const newItem = { ...form, id: newDocRef.id, masterItem: masterItemMap[form.masterItemId] };
                await logChange(db, user, newItem, "new", form.quantity, form.quantity);
              }
              closeModal();
            } catch (err) { console.error("Error saving inventory item: ", err); }
          };
          
          const handleTakeStock = async (takeAmount) => {
            if (!db || !user || !currentItem || !canManage) return;
            const newQuantity = currentItem.quantity - takeAmount;
            try {
              await logChange(db, user, currentItem, "used", -takeAmount, newQuantity, currentItem.status);
              const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', currentItem.id);
              await updateDoc(docRef, { quantity: newQuantity });
              closeModal();
            } catch (err) { console.error("Error taking stock: ", err); }
          };
          
          const handleDelete = async (item) => {
            if (!canManage || !window.confirm(t('inventory.deleteConfirm', {lotNumber: item.lotNumber}))) return;
            if (!db || !user) return;
            try {
              await logChange(db, user, item, "deleted", -item.quantity, 0, t('inventory.status.disposed'));
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', item.id));
            } catch (err) { console.error("Error deleting item: ", err); }
          };
          
          const handleStatusChange = async (docId, newStatus) => {
            if (!db || !user || !canManage) return;
            const item = inventoryItems.find(i => i.id === docId);
            if (!item) return;
            try {
              await logChange(db, user, item, "status", 0, item.quantity, newStatus);
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activeInventory', docId), { status: newStatus });
            } catch (err) { console.error("Error updating status: ", err); }
          };
          
          const getStatusColor = (status, expDate) => {
            const isExpired = expDate && new Date(expDate) < new Date();
            if (status === t('inventory.status.disposed')) return 'bg-gray-200 text-gray-800';
            if (status === t('inventory.status.expired') || isExpired) return 'bg-red-100 text-red-800';
            if (status === t('inventory.status.quarantined')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-green-100 text-green-800';
          };
          
          const lowStockItems = useMemo(() => {
            return inventoryItems.map(item => {
                const masterItem = masterItemMap[item.masterItemId];
                const threshold = masterItem?.lowStockThreshold || 3;
                if (item.quantity <= threshold && item.status === t('inventory.status.approved')) {
                  return { id: item.id, name: masterItem ? `${masterItem.itemId} - ${masterItem.nameAndSpec}` : 'Unknown Item',
                    quantity: item.quantity, threshold: threshold, };
                }
                return null;
              }).filter(Boolean);
          }, [inventoryItems, masterItemMap, t]);

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('inventory.title')}</h2>
                {canManage && (
                  <Button onClick={openAddModal} variant="primary" disabled={masterItems.length === 0}>
                    <IconPlus /> {t('inventory.addNew')}
                  </Button>
                )}
              </div>
              
              {masterItems.length === 0 && (
                 <div className="bg-yellow-100 border-s-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-start" role="alert">
                   <p>{t('inventory.noMasterItem')}</p>
                 </div>
              )}

              {lowStockItems.length > 0 && (
                <div className="bg-yellow-50 border-s-4 border-yellow-400 p-4 mb-4 rounded-md shadow-sm text-start">
                  <div className="flex items-center gap-3">
                    <IconAlertTriangle />
                    <h3 className="text-lg font-semibold text-yellow-800">{t('inventory.lowStockWarn')}</h3>
                  </div>
                  <ul className="mt-2 list-disc list-inside text-yellow-700 space-y-1">
                    {lowStockItems.map(item => (
                      <li key={item.id}>
                        <strong>{item.name}:</strong> {t('inventory.lowStockMsg', {quantity: item.quantity, threshold: item.threshold})}
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {isLoading && <p>{t('inventory.loading')}</p>}
              {error && <p className="text-red-500">{t('inventory.error')}</p>}

              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.name')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.lot')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.expires')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.quantity')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.location')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.status')}</th>
                      {canManage && <th className="px-6 py-3 text-end text-xs font-medium text-gray-500 uppercase tracking-wider">{t('inventory.header.actions')}</th>}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {inventoryItems.map((item) => {
                      const masterItem = item.masterItem;
                      const itemName = masterItem ? `${masterItem.itemId} - ${masterItem.nameAndSpec}` : "Loading...";
                      const statusColor = getStatusColor(item.status, item.expirationDate);
                      const lowStockThreshold = masterItem?.lowStockThreshold || 3;
                      const isLowStock = item.quantity <= lowStockThreshold && item.status === t('inventory.status.approved');
                      const canTake = item.quantity > 0 && item.status === t('inventory.status.approved') && canManage;
                      
                      return (
                        <tr key={item.id}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{itemName}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lotNumber}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm ${statusColor.includes('red') ? 'font-bold' : 'text-gray-500'}`}>{formatDate(item.expirationDate)}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm text-center ${isLowStock ? 'font-bold text-yellow-700' : 'text-gray-500'}`}>{isLowStock && <IconAlertTriangle />}{item.quantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.storageLocation}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm">
                            <select value={item.status} onChange={(e) => handleStatusChange(item.id, e.target.value)} disabled={!canManage} className={`text-xs font-medium rounded-full p-1 border-none ${statusColor}`}>
                              {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                          </td>
                          {canManage && (
                            <td className="px-6 py-4 whitespace-nowrap text-end text-sm font-medium">
                              <div className="flex justify-end gap-2">
                                <Button variant="warning" onClick={() => openTakeModal(item)} aria-label={t('inventory.take')} disabled={!canTake}>
                                  <IconMinus /> {t('inventory.take')}
                                </Button>
                                <Button variant="secondary" onClick={() => openEditModal(item)} aria-label={t('inventory.edit')}><IconEdit /></Button>
                                <Button variant="danger" onClick={() => handleDelete(item)} aria-label={t('inventory.delete')}><IconTrash /></Button>
                              </div>
                            </td>
                          )}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              <Modal isOpen={isModalOpen} onClose={closeModal} title={isEditing ? t('inventory.modal.editTitle') : t('inventory.modal.addTitle')} allowClose={true}>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <Select label={t('inventory.modal.masterItem')} id="masterItemId" name="masterItemId" value={form.masterItemId} onChange={handleChange} required disabled={isEditing}>
                    <option value="" disabled>{t('inventory.modal.selectItem')}</option>
                    {masterItems.map(item => (<option key={item.id} value={item.id}>{item.itemId} - {item.nameAndSpec}</option>))}
                  </Select>
                  <Input label={t('inventory.modal.lot')} id="lotNumber" name="lotNumber" value={form.lotNumber} onChange={handleChange} required disabled={isEditing} />
                  <Input label={t('inventory.modal.received')} id="dateReceived" name="dateReceived" type="date" value={form.dateReceived} onChange={handleChange} required />
                  <Input label={t('inventory.modal.expires')} id="expirationDate" name="expirationDate" type="date" value={form.expirationDate} onChange={handleChange} />
                  <Input label={t('inventory.modal.quantity')} id="quantity" name="quantity" type="number" min="0" value={form.quantity} onChange={handleChange} required />
                  <Input label={t('inventory.modal.location')} id="storageLocation" name="storageLocation" value={form.storageLocation} onChange={handleChange} />
                  <Select label={t('inventory.modal.status')} id="status" name="status" value={form.status} onChange={handleChange}>
                    {statuses.map(s => <option key={s} value={s}>{s}</option>)}
                  </Select>
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <Button type="button" variant="secondary" onClick={closeModal}>{t('masterList.modal.cancel')}</Button>
                    <Button type="submit" variant="primary">{isEditing ? t('masterList.modal.save') : t('masterList.modal.add')}</Button>
                  </div>
                </form>
              </Modal>
              
              <TakeStockModal isOpen={isTakeModalOpen} onClose={closeModal} item={currentItem} onConfirm={handleTakeStock} />
            </div>
          );
        };

        // --- Inventory Log Component ---
        const InventoryLog = ({ db, masterItemMap }) => {
          const { t } = useLang();
          const [logItems, setLogItems] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);

          useEffect(() => {
            if (!db) return;
            setIsLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventoryLog');
            const q = query(collectionRef, orderBy('timestamp', 'desc')); 
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const items = snapshot.docs.map(doc => {
                const data = doc.data();
                return { id: doc.id, ...data, masterItem: masterItemMap[data.masterItemId] || { itemId: 'N/A', nameAndSpec: 'N/A' } }
              });
              setLogItems(items);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching log: ", err); setError(t('log.error')); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, masterItemMap]);
          
          const handleExport = () => {
             const headers = ['timestamp', 'userEmail', 'itemName', 'lotNumber', 'action', 'quantityChange', 'newQty', 'status'];
            exportToCSV(logItems, headers, 'inventory-log.csv', t);
          };
          
          const getActionColor = (action) => {
            if (action.includes(translations.en.log.actions.added)) return 'text-green-600';
            if (action.includes(translations.en.log.actions.used)) return 'text-yellow-700';
            if (action.includes(translations.en.log.actions.deleted)) return 'text-red-600';
            return 'text-gray-600';
          };
          
          const formatChange = (change) => {
            if (change > 0) return `+${change}`;
            if (change < 0) return `${change}`;
            return '0';
          }

          return (
            <div className="p-4">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-semibold text-gray-800">{t('log.title')}</h2>
                <Button onClick={handleExport} variant="secondary">
                  <IconDownload /> {t('log.export')}
                </Button>
              </div>
              
              {isLoading && <p>{t('log.loading')}</p>}
              {error && <p className="text-red-500">{t('log.error')}</p>}

              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.timestamp')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.user')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.name')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.lot')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.action')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.change')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.newQty')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('log.header.status')}</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {logItems.map((item) => {
                      // Translate action and status for display
                      const actionKey = Object.keys(translations.en.log.actions).find(key => translations.en.log.actions[key] === item.action);
                      const displayAction = t(`log.actions.${actionKey}`) || item.action;
                      
                      const statusKey = Object.keys(translations.en.inventory.status).find(key => translations.en.inventory.status[key] === item.status);
                      const displayStatus = t(`inventory.status.${statusKey}`) || item.status;
                      
                      return (
                        <tr key={item.id}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(item.timestamp, true)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800">{item.userEmail}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{item.itemName}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.lotNumber}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${getActionColor(item.action)}`}>{displayAction}</td>
                          <td className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${getActionColor(item.action)}`}>{formatChange(item.quantityChange)}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.newQuantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{displayStatus}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };
        
        // --- Manage Accounts Component ---
        const ManageAccounts = ({ db, user, userRole }) => {
          const { t } = useLang();
          const [users, setUsers] = useState([]);
          const [isLoading, setIsLoading] = useState(true);
          const [error, setError] = useState(null);
          
          const roles = Object.keys(t('admin.roles')); // ['admin', 'technician', 'viewer']

          useEffect(() => {
            if (!db || userRole !== 'admin') {
              setIsLoading(false);
              return;
            };
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const userList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setUsers(userList);
              setIsLoading(false);
            }, (err) => { console.error("Error fetching users: ", err); setError(t('admin.error')); setIsLoading(false); });
            return () => unsubscribe();
          }, [db, userRole]);
          
          const handleRoleChange = async (userId, newRole) => {
            if (userId === user.uid && newRole !== 'admin') {
              if (!window.confirm(t('admin.demoteWarning'))) {
                return;
              }
            }
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
              await updateDoc(userDocRef, { role: newRole });
            } catch (err) { console.error("Error updating role: ", err); }
          };

          if (userRole !== 'admin') {
            return <div className="p-4 text-red-600">{t('admin.noPermission')}</div>;
          }
          if (isLoading) return <p>{t('admin.loading')}</p>;
          if (error) return <p className="text-red-500">{error}</p>;

          return (
            <div className="p-4">
              <h2 className="text-2xl font-semibold text-gray-800 mb-4">{t('admin.title')}</h2>
              
              <div className="bg-white shadow-md rounded-lg overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-start">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.header.email')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.header.uid')}</th>
                      <th className="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase tracking-wider">{t('admin.header.role')}</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {users.map((u) => (
                      <tr key={u.id}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{u.email}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{u.id}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <Select id={`role-${u.id}`} value={u.role} onChange={(e) => handleRoleChange(u.id, e.target.value)}>
                            {roles.map(r => <option key={r} value={r}>{t(`admin.roles.${r}`)}</option>)}
                          </Select>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };
        
        
        // --- Auth Page Component ---
        const AuthPage = ({ auth, db }) => {
          const { t } = useLang();
          const [isLoginView, setIsLoginView] = useState(true);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState(null);
          const [loading, setLoading] = useState(false);

          const handleAuthError = (err) => {
            switch (err.code) {
              case 'auth/user-not-found':
              case 'auth/wrong-password': setError(t('auth.error.invalid')); break;
              case 'auth/email-already-in-use': setError(t('auth.error.inUse')); break;
              case 'auth/weak-password': setError(t('auth.error.weakPass')); break;
              default: setError(t('auth.error.unknown'));
            }
            console.error("Auth Error: ", err);
          };
          
          const createNewUserDocument = async (user) => {
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
              // Set default role to 'viewer'
              await setDoc(userDocRef, {
                email: user.email,
                role: 'viewer' 
              });
            } catch (err) { console.error("Error creating user role document: ", err); }
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError(null);
            try {
              if (isLoginView) {
                await signInWithEmailAndPassword(auth, email, password);
              } else {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await createNewUserDocument(userCredential.user);
              }
            } catch (err) {
              handleAuthError(err);
              setLoading(false);
            }
          };

          return (
            <div className="min-h-screen flex items-center justify-center bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
              <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-lg shadow-md">
                <div><h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">{isLoginView ? t('auth.signInTitle') : t('auth.signUpTitle')}</h2></div>
                <div className="flex border-b border-gray-200">
                  <button onClick={() => setIsLoginView(true)} className={`w-1/2 py-4 px-1 text-center text-sm font-medium ${isLoginView ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>{t('auth.signIn')}</button>
                  <button onClick={() => setIsLoginView(false)} className={`w-1/2 py-4 px-1 text-center text-sm font-medium ${!isLoginView ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>{t('auth.signUp')}</button>
                </div>
                <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                  <Input label={t('auth.email')} id="email-address" name="email" type="email" autoComplete="email" required value={email} onChange={(e) => setEmail(e.target.value)} />
                  <Input label={t('auth.password')} id="password" name="password" type="password" autoComplete="current-password" required value={password} onChange={(e) => setPassword(e.target.value)} />
                  {error && <p className="text-red-600 text-sm text-center">{error}</p>}
                  <div><Button type="submit" variant="primary" className="w-full justify-center" disabled={loading}>{loading ? t('auth.processing') : (isLoginView ? t('auth.signIn') : t('auth.createAccount'))}</Button></div>
                </form>
              </div>
            </div>
          );
        };


        // --- Main App Component ---
        function App() {
          const { t, language, setLanguage } = useLang();
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [currentUser, setCurrentUser] = useState(null);
          const [userRole, setUserRole] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [currentPage, setCurrentPage] = useState('inventory'); 
          const [masterItems, setMasterItems] = useState([]);
          const [masterLoading, setMasterLoading] = useState(true);
          const [masterError, setMasterError] = useState(null);
          const [authError, setAuthError] = useState(null);

          // Initialize Firebase and Auth
          useEffect(() => {
            if (!window.firebase) {
              console.error("Firebase SDKs not loaded!");
              setAuthError(t('app.connectionErrorMsg'));
              setIsAuthReady(true); return;
            }
            try {
              const app = initializeApp(firebaseConfig);
              const authInstance = getAuth(app);
              const dbInstance = getFirestore(app);
              setAuth(authInstance);
              setDb(dbInstance);

              const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                  const userDocRef = doc(dbInstance, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                  const userDoc = await getDoc(userDocRef);
                  if (userDoc.exists()) {
                    setUserRole(userDoc.data().role);
                  } else {
                     try {
                       // This handles the very first 'admin' user you created manually
                       // or any user that was created before the role system was in place
                       const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                       const userDoc = await getDoc(userDocRef);
                       if (userDoc.exists() && userDoc.data().role) {
                         setUserRole(userDoc.data().role);
                       } else {
                         // This is a failsafe for a user who exists in Auth but not in Firestore
                         await setDoc(userDocRef, { email: user.email, role: 'viewer' });
                         setUserRole('viewer');
                       }
                     } catch (e) { console.error("Error creating user doc on the fly: ", e); }
                  }
                  setCurrentUser(user);
                  setAuthError(null);
                } else {
                  setCurrentUser(null);
                  setUserRole(null);
                }
                setIsAuthReady(true);
              });
              return () => unsubscribe();
              
            } catch (e) {
              console.error("Error initializing Firebase: ", e);
              setAuthError(t('app.authError'));
              setIsAuthReady(true); 
            }
          }, []);

          // Fetch Master List
          useEffect(() => {
            if (!isAuthReady || !db || !currentUser) {
                if (currentUser === null) setMasterLoading(false);
                return;
            }
            setMasterLoading(true);
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'masterList');
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setMasterItems(items);
              setMasterLoading(false);
            }, (err) => {
              console.error("Error fetching master list: ", err);
              setMasterError(t('masterList.error'));
              setMasterLoading(false);
            });
            return () => unsubscribe();
          }, [db, isAuthReady, currentUser, t]);
          
          const handleSignOut = async () => {
            if (auth) {
              try { await signOut(auth); } catch (err) { console.error("Error signing out: ", err); }
            }
          };

          const NavButton = ({ page, label, icon }) => (
            <button
              onClick={() => setCurrentPage(page)}
              className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium ${
                currentPage === page ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-200'
              }`}
            >
              {icon}
              {label}
            </button>
          );
          
          const LanguageSwitcher = () => {
            return (
              <div className="flex items-center gap-1 bg-gray-200 rounded-full p-1">
                <button 
                  onClick={() => setLanguage('en')}
                  className={`px-3 py-1 rounded-full text-sm font-medium ${language === 'en' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-700'}`}
                >
                  English
                </button>
                <button 
                  onClick={() => setLanguage('fa')}
                  className={`px-3 py-1 rounded-full text-sm font-medium ${language === 'fa' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-700'}`}
                >
                  فارسی
                </button>
              </div>
            );
          };
          
          const masterItemMap = useMemo(() => {
            return masterItems.reduce((acc, item) => {
              acc[item.id] = item;
              return acc;
            }, {});
          }, [masterItems]);
          
          // --- Main Render Logic ---
          if (!isAuthReady) {
             return <div id="loading">{t('app.loading')}</div>
          }
          if (authError) {
             return (
                <div className="bg-red-100 border-s-4 border-red-500 text-red-700 p-4 m-4 text-start" role="alert">
                  <p className="font-bold">{t('app.connectionError')}</p><p>{authError}</p>
                </div>
              );
          }
          if (!currentUser || !userRole) {
            if (!currentUser) {
              return <AuthPage auth={auth} db={db} />
            }
            return <div id="loading">{t('app.loadingPermissions')}</div>
          }

          const PageContent = () => {
            switch(currentPage) {
              case 'inventory':
                return <ActiveInventory db={db} user={currentUser} userRole={userRole} masterItems={masterItems} />;
              case 'master':
                return <MasterList db={db} user={currentUser} userRole={userRole} masterItems={masterItems} isLoading={masterLoading} error={masterError} />;
              case 'log':
                return <InventoryLog db={db} masterItemMap={masterItemMap} />;
              case 'admin':
                return <ManageAccounts db={db} user={currentUser} userRole={userRole} />;
              default:
                return <ActiveInventory db={db} user={currentUser} userRole={userRole} masterItems={masterItems} />;
            }
          };

          return (
            <div className="min-h-screen font-sans">
              <header className="bg-white shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex justify-between items-center h-16">
                    <div className="flex items-center gap-3">
                      <IconClipboard />
                      <h1 className="text-xl font-semibold text-gray-900">{t('app.title')}</h1>
                    </div>
                    <nav className="hidden md:flex space-x-2">
                      <NavButton page="inventory" label={t('nav.inventory')} icon={<IconClipboard />} />
                      <NavButton page="master" label={t('nav.masterList')} icon={<IconEdit />} />
                      <NavButton page="log" label={t('nav.log')} icon={<IconHistory />} />
                      {userRole === 'admin' && (
                        <NavButton page="admin" label={t('nav.admin')} icon={<IconAdmin />} />
                      )}
                    </nav>
                    <div className="flex items-center gap-4">
                      <LanguageSwitcher />
                      <div className="hidden sm:block text-sm font-medium text-gray-600">
                        {t('app.user')}: <span className="font-bold text-blue-600">{currentUser.email}</span> (<span className="italic">{t(`admin.roles.${userRole}`)}</span>)
                      </div>
                      <Button onClick={handleSignOut} variant="secondary" className="px-3 py-1.5">
                        <IconSignOut /> <span className="hidden sm:inline">{t('app.signOut')}</span>
                      </Button>
                    </div>
                  </div>
                  {/* Mobile Nav */}
                  <nav className="flex md:hidden space-x-2 pb-2 justify-center">
                      <NavButton page="inventory" label={t('nav.inventory')} icon={<IconClipboard />} />
                      <NavButton page="master" label={t('nav.masterList')} icon={<IconEdit />} />
                      <NavButton page="log" label={t('nav.log')} icon={<IconHistory />} />
                      {userRole === 'admin' && (
                        <NavButton page="admin" label={t('nav.admin')} icon={<IconAdmin />} />
                      )}
                    </nav>
                </div>
              </header>
              <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <PageContent />
              </main>
            </div>
          );
        }

        // 6. Render the App, wrapped in the Language Provider
        const checkFirebase = setInterval(() => {
          if (window.firebase) {
            clearInterval(checkFirebase);
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
              <LangProvider>
                <App />
              </LangProvider>
            );
          }
        }, 100);

    </script>
</body>
</html>

